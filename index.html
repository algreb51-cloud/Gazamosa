<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة إدارة البيانات الاحترافية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1); border-color: #6366f1; }
        .modal-anim { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .status-badge { transition: all 0.2s ease; }
        .status-badge:hover { filter: brightness(0.95); }
        th, td { white-space: nowrap; }

        /* ========================================= */
        /* تنسيقات الطباعة المحسنة          */
        /* ========================================= */
        @media print {
            body * { visibility: hidden; }
            #authOverlay, #mainUI, #formModal, #detailsModal, #exportModal, #passwordModal, nav { display: none !important; }
            #printArea, #printArea * { visibility: visible; display: block; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; font-size: 12pt; }
            @page { size: A4; margin: 1cm; }
            .print-container { width: 100%; direction: rtl; }
            .print-header { text-align: center; border-bottom: 3px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .print-title { font-size: 24pt; font-weight: 900; margin: 0; }
            .print-meta { font-size: 10pt; color: #555; margin-top: 5px; }
            .section-title { font-size: 16pt; font-weight: bold; background-color: #eee !important; -webkit-print-color-adjust: exact; padding: 8px 10px; margin-top: 25px; margin-bottom: 10px; border-right: 5px solid #000; border-bottom: 1px solid #ccc; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 6px 10px; text-align: right; font-size: 11pt; }
            .print-table th { background-color: #f3f3f3 !important; -webkit-print-color-adjust: exact; font-weight: bold; width: 20%; white-space: nowrap; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxI5hPvlddgn9aZUrewesDbg8YSD7bEnk",
            authDomain: "mosadata-18521.firebaseapp.com",
            projectId: "mosadata-18521",
            storageBucket: "mosadata-18521.firebasestorage.app",
            messagingSenderId: "517965913092",
            appId: "1:517965913092:web:39db81b21739cef58e6951",
            measurementId: "G-C00LHCKEG7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "mosadata-18521";

        // تصدير المتغيرات للنطاق العام
        window.db = db;
        window.fs = { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, getDocs };
        window.appId = appId;
        window.auth = auth;

        // ===========================================
        //       إصلاح نظام المصادقة (Fixed Logic)
        // ===========================================

        // مراقب حالة تسجيل الدخول الصحيح
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // المستخدم مسجل دخول
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainUI').classList.remove('hidden');

                if (user.isAnonymous) {
                    // زائر
                    window.currentRole = 'visitor';
                    setupVisitorUI();
                } else {
                    // مسؤول
                    window.currentRole = 'admin';
                    setupAdminUI(user.email);
                }
                initDataListener();
            } else {
                // غير مسجل
                document.getElementById('authOverlay').classList.remove('hidden');
                document.getElementById('mainUI').classList.add('hidden');
            }
        });

        // دالة دخول المسؤول
        window.verifyAdmin = async function() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await signInWithEmailAndPassword(auth, email, pass);
                closeModal('passwordModal');
                errorDiv.classList.add('hidden');
            } catch (error) {
                console.error("Login Error:", error);
                errorDiv.innerText = "البريد الإلكتروني أو كلمة المرور غير صحيحة";
                errorDiv.classList.remove('hidden');
            }
        };

        // دالة دخول الزائر
        window.loginVisitor = function() {
            signInAnonymously(auth).catch((error) => {
                console.error("Visitor Login Error", error);
                alert("حدث خطأ أثناء الدخول كزائر: " + error.message);
            });
        };

        // دالة الخروج
        window.logout = async function() {
            try {
                await signOut(auth);
                location.reload();
            } catch (error) {
                console.error("Logout Error", error);
            }
        };

        // ===========================================
        //       جلب البيانات
        // ===========================================
        function initDataListener() {
            const q = query(
                collection(db, "artifacts", appId, "public", "data", "families"),
                orderBy("updatedAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                window.families = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                runFilters();
            }, (err) => console.error("Firebase Snapshot Error", err));
        }

    </script>
</head>
<body class="custom-scroll">

    <div id="printArea" class="hidden"></div>

    <div id="authOverlay" class="fixed inset-0 bg-slate-900 z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 w-full max-w-md text-center modal-anim">
            <div class="mb-8">
                <div class="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-indigo-200">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                </div>
                <h1 class="text-3xl font-black text-slate-800">بوابة الأرشفة</h1>
                <p class="text-slate-400 mt-2">نظام إدارة البيانات السحابي المتطور</p>
            </div>
            <div class="space-y-4">
                <button onclick="requestAdmin()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold hover:bg-black transition-all flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    دخول المسؤولين
                </button>
                <button onclick="loginVisitor()" class="w-full bg-indigo-50 text-indigo-600 py-5 rounded-2xl font-bold hover:bg-indigo-100 transition-all">مشاهدة كزائر</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="fixed inset-0 bg-black/60 hidden z-[1100] flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl modal-anim">
            <h3 class="text-xl font-bold mb-6 text-slate-800">تسجيل دخول المسؤول</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 mr-1">البريد الإلكتروني</label>
                    <input type="email" id="adminEmail" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-left text-sm font-bold focus:ring-2 focus:ring-indigo-500" placeholder="admin@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 mr-1">كلمة المرور</label>
                    <input type="password" id="adminPass" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-center text-xl tracking-widest focus:ring-2 focus:ring-indigo-500" placeholder="••••••••">
                </div>
            </div>
            <div id="loginError" class="text-red-500 text-xs font-bold mt-4 hidden text-center">بيانات الدخول غير صحيحة</div>
            <div class="flex gap-3 mt-6">
                <button onclick="verifyAdmin()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition-all">دخول</button>
                <button onclick="closeModal('passwordModal')" class="flex-1 bg-slate-100 py-4 rounded-xl font-bold hover:bg-slate-200 transition-all">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="mainUI" class="hidden min-h-screen">
        <nav class="fixed bottom-0 left-0 right-0 md:top-0 md:right-0 md:h-screen md:w-24 bg-white border-t md:border-t-0 md:border-l border-slate-200 z-[500] flex md:flex-col items-center justify-center gap-6 p-4 md:p-8">
            <div class="hidden md:block mb-auto">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-100">DB</div>
            </div>
            <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="p-4 rounded-2xl text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></button>
            <button onclick="openForm()" id="adminAddBtn" class="hidden p-4 rounded-2xl bg-indigo-600 text-white shadow-lg shadow-indigo-100 transition-all hover:scale-110"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>
            
            <button id="navExportBtn" onclick="openExportModal()" class="p-4 rounded-2xl text-slate-400 hover:bg-indigo-50 hover:text-indigo-600 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button>
            
            <button onclick="logout()" class="p-4 md:mt-auto rounded-2xl text-red-400 hover:bg-red-50 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
        </nav>

        <main class="pb-24 md:pb-8 md:pr-24 min-h-screen">
            <div class="max-w-[95%] mx-auto p-4 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                    <div>
                        <h1 class="text-3xl font-black text-slate-800">لوحة التحكم</h1>
                        <p id="roleTitle" class="text-slate-500 font-medium">مرحباً بك، وضع المشاهدة</p>
                    </div>
                    <div id="syncStatus" class="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold animate-pulse">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> متصل بالسحابة
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5">
                        <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">إجمالي الأفراد</p><h2 id="totalPersons" class="text-3xl font-black text-slate-800">0</h2></div>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5">
                        <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">إجمالي العائلات</p><h2 id="totalFamilies" class="text-3xl font-black text-slate-800">0</h2></div>
                    </div>
                    <button onclick="toggleDuplicateFilter()" class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5 hover:border-red-300 transition-all text-right group">
                        <div id="dupIconBox" class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-600 group-hover:bg-red-600 group-hover:text-white transition-all"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 15c-.77 1.333.192 3 1.732 3z"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">هويات مكررة</p><h2 id="totalDuplicates" class="text-3xl font-black text-red-600">0</h2></div>
                    </button>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm mb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                        <div class="lg:col-span-2 relative">
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">بحث ذكي (اسم، هوية، مندوب، عدد الأفراد)</label>
                            <input type="text" id="searchInput" oninput="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 pr-12 text-sm input-focus" placeholder="ابحث بالاسم، الهوية، المندوب، أو عدد أفراد العائلة...">
                            <svg class="w-6 h-6 text-slate-300 absolute right-4 top-11" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        
                        <div class="contents" id="sensitiveFilters">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">حسب العمر (استخراج أفراد)</label>
                                <select id="filterAge" onchange="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer hover:bg-slate-100 transition-all">
                                    <option value="all">كل الأعمار (عائلات)</option>
                                    <option value="0-1">0 - 1 سنة</option>
                                    <option value="1-2">1 - 2 سنة</option>
                                    <option value="2-5">2 - 5 سنوات</option>
                                    <option value="5-10">5 - 10 سنوات</option>
                                    <option value="10-17">10 - 17 سنة</option>
                                    <option value="18-25">18 - 25 سنة</option>
                                    <option value="26-40">26 - 40 سنة</option>
                                    <option value="41-80">41 - 80 سنة</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">حسب المرض (استخراج أفراد)</label>
                                <select id="filterDisease" onchange="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer hover:bg-slate-100 transition-all">
                                    <option value="all">كل الحالات (عائلات)</option>
                                    <option value="مرض مزمن">مرض مزمن</option>
                                    <option value="اعاقة سمعية">إعاقة سمعية</option>
                                    <option value="اعاقة حركية">إعاقة حركية</option>
                                    <option value="اعاقة بصرية">إعاقة بصرية</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end mt-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">المندوب (بيانات عائلية)</label>
                            <select id="filterDelegate" onchange="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer">
                                <option value="all">كل المناديب</option>
                                <option>موسى</option><option>نبيل</option><option>عبدالحميد</option><option>محمد عادل</option>
                            </select>
                        </div>
                        <div id="socialFilterDiv">
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">الحالة الاجتماعية (بيانات عائلية)</label>
                            <select id="filterSocial" onchange="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer">
                                <option value="all">كل الحالات</option>
                                <option>متزوج</option><option>ارمله</option><option>مطلقة</option><option>مهجورة</option><option>اعزب</option><option>أيتام</option>
                            </select>
                        </div>
                        
                        <div class="lg:col-span-2 flex gap-3" id="adminActions">
                            <button onclick="downloadTemplate()" class="flex-1 bg-white border border-slate-200 text-slate-600 p-4 rounded-2xl text-xs font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/></svg>
                                تحميل النموذج
                            </button>
                            <label class="flex-1 bg-indigo-50 text-indigo-600 p-4 rounded-2xl text-xs font-bold hover:bg-indigo-100 transition-all flex items-center justify-center gap-2 cursor-pointer">
                                <input type="file" id="importExcel" hidden onchange="importData(event)">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0l-4-4m4 4v12"/></svg>
                                استيراد إكسل
                            </label>
                            <button onclick="exportCurrentView()" class="flex-1 bg-emerald-600 text-white p-4 rounded-2xl text-xs font-bold hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100 flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                تصدير الفرز
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead id="tableHeader" class="bg-slate-50/50 text-slate-400 text-xs font-bold uppercase tracking-widest border-b">
                                </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-50 text-sm">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="formModal" class="fixed inset-0 bg-slate-900/60 hidden z-[1200] overflow-y-auto p-4 md:p-12 backdrop-blur-sm">
        <div class="bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl mx-auto modal-anim overflow-hidden">
            <div class="p-8 md:p-12 border-b border-slate-50 flex items-center justify-between">
                <div>
                    <h2 id="modalTitle" class="text-3xl font-black text-slate-800">إضافة بيانات عائلة</h2>
                    <p class="text-slate-400 text-sm mt-1">أدخل البيانات بدقة لضمان دقة الأرشفة</p>
                </div>
                <button onclick="closeModal('formModal')" class="p-4 bg-slate-50 text-slate-400 rounded-2xl hover:bg-red-50 hover:text-red-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <form id="mainForm" onsubmit="handleSave(event)" class="p-8 md:p-12 space-y-12">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 mb-2">الاسم الرباعي لرب الأسرة</label>
                        <input type="text" id="pName" required class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">رقم الهوية (9 أرقام)</label>
                        <input type="text" id="pId" maxlength="9" required oninput="only9Numbers(this)" class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-mono tracking-widest font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">رقم الجوال (بدون 0)</label>
                        <input type="text" id="pPhone" maxlength="9" required oninput="only9Numbers(this)" placeholder="59XXXXXXX" class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-mono font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الميلاد</label>
                        <input type="date" id="pDob" required class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">الحالة الاجتماعية</label>
                        <select id="pSocial" class="w-full bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                            <option>متزوج</option><option>ارمله</option><option>مطلقة</option><option>مهجورة</option><option>اعزب</option><option>أيتام</option>
                        </select>
                    </div>
                </div>

                <div class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100">
                    <h3 class="text-slate-800 font-bold mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM6 8a2 2 0 11-4 0 2 2 0 014 0zM11 18a6 6 0 00-12 0c0 .099.01.196.03.291A5.985 5.985 0 014 13.06V11a2 2 0 10-4 0v2.06A8 8 0 0015 18z"></path></svg>
                        بيانات الزوجة
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="text" id="wifeName" placeholder="اسم الزوجة" class="bg-white border-none rounded-2xl p-5 text-sm font-bold shadow-sm">
                        <input type="text" id="wifeId" maxlength="9" oninput="only9Numbers(this)" placeholder="هوية الزوجة" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                        <input type="date" id="wifeDob" class="bg-white border-none rounded-2xl p-5 text-sm shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <input type="text" id="pDelegate" placeholder="المندوب (موسى، نبيل..)" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="text" id="pAltPhone" maxlength="9" oninput="only9Numbers(this)" placeholder="جوال بديل" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-mono">
                    <input type="text" id="originArea" placeholder="السكن الأصلي" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="text" id="displaceArea" placeholder="منطقة النزوح" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="totalCount" placeholder="إجمالي الأفراد" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="maleCount" placeholder="عدد الذكور" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="femaleCount" placeholder="عدد الإناث" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                </div>

                <div class="pt-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-slate-800 font-bold text-xl">أفراد العائلة</h3>
                        <button type="button" onclick="addMemberRow()" class="px-6 py-3 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-black transition-all">+ إضافة فرد</button>
                    </div>
                    <div id="membersList" class="space-y-4"></div>
                </div>

                <div class="pt-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-red-600 font-bold text-xl">الحالات الصحية</h3>
                        <button type="button" onclick="addHealthRow()" class="px-6 py-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold hover:bg-red-100 transition-all">+ إضافة حالة</button>
                    </div>
                    <div id="healthList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div class="bg-emerald-50 p-8 rounded-[2.5rem] border border-emerald-100">
                    <h3 class="text-emerald-900 font-bold mb-6">المحفظة الإلكترونية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="text" id="walletOwner" placeholder="اسم مالك المحفظة" class="bg-white border-none rounded-2xl p-5 text-sm font-bold shadow-sm">
                        <input type="text" id="walletId" maxlength="9" oninput="only9Numbers(this)" placeholder="هوية المالك" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                        <input type="text" id="walletPhone" maxlength="9" oninput="only9Numbers(this)" placeholder="جوال المحفظة" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                    </div>
                </div>

                <div class="pt-10 flex gap-4">
                    <button type="submit" class="flex-[2] bg-indigo-600 text-white py-6 rounded-3xl font-black text-xl shadow-2xl shadow-indigo-200 hover:scale-[1.02] active:scale-95 transition-all">حفظ البيانات سحابياً</button>
                    <button type="button" onclick="closeModal('formModal')" class="flex-1 bg-slate-100 text-slate-500 py-6 rounded-3xl font-bold hover:bg-slate-200 transition-all">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1300] overflow-y-auto p-4 md:p-12 backdrop-blur-md">
        <div class="bg-white w-full max-w-4xl rounded-[3.5rem] shadow-2xl mx-auto modal-anim overflow-hidden">
            <div id="detailsContent" class="p-10 md:p-16">
                </div>
            <div class="p-10 bg-slate-50 flex justify-between items-center border-t border-slate-100">
                <button onclick="closeModal('detailsModal')" class="px-10 py-4 bg-white border border-slate-200 rounded-2xl font-bold text-slate-500 hover:bg-slate-100 transition-all">إغلاق</button>
                <div class="flex gap-2" id="detailActions">
                    </div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-[1400] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-[3rem] p-10 w-full max-w-xl shadow-2xl modal-anim">
            <h3 class="text-2xl font-black text-slate-800 mb-6">تخصيص التصدير</h3>
            <p class="text-slate-400 mb-6">اختر الأعمدة التي ترغب في تضمينها في ملف الإكسل</p>
            <div id="exportFieldCheckboxes" class="grid grid-cols-2 gap-3 mb-8 max-h-[40vh] overflow-y-auto p-2 bg-slate-50 rounded-2xl custom-scroll">
                </div>
            <div class="flex gap-4">
                <button onclick="runCustomExport()" class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-xl shadow-indigo-100">تصدير للملف</button>
                <button onclick="closeModal('exportModal')" class="flex-1 bg-slate-100 text-slate-500 py-5 rounded-2xl font-bold">تراجع</button>
            </div>
        </div>
    </div>

    <div id="undoToast" class="fixed bottom-10 left-10 right-10 md:left-1/2 md:-translate-x-1/2 md:w-fit bg-slate-900 text-white px-8 py-6 rounded-[2rem] shadow-2xl flex items-center justify-between gap-12 z-[2000] hidden transform transition-all duration-500">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-red-500/20 text-red-400 rounded-2xl flex items-center justify-center animate-pulse">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </div>
            <div>
                <p class="font-bold">تم حذف البيانات سحابياً</p>
                <p class="text-slate-400 text-xs mt-1">لديك 5 ثوانٍ لاستعادة البيانات</p>
            </div>
        </div>
        <button onclick="cancelDelete()" class="bg-white text-slate-900 px-8 py-3 rounded-xl font-bold hover:bg-indigo-50 transition-all">تراجع الآن</button>
    </div>

    <script>
        window.families = [];
        window.currentRole = 'visitor';
        let deleteTimer = null;
        let pendingDeleteId = null;
        let showDupsOnly = false;
        let currentViewData = []; 
        let currentViewMode = 'family'; 

        const FIELD_MAP = {
            pName: "اسم رب الأسرة",
            pId: "هوية رب الأسرة",
            pDob: "تاريخ ميلاد رب الأسرة",
            pPhone: "رقم الجوال",
            wifeName: "اسم الزوجة",
            wifeId: "هوية الزوجة",
            wifeDob: "تاريخ ميلاد الزوجة",
            pSocial: "الحالة الاجتماعية",
            pDelegate: "اسم المندوب",
            pAltPhone: "جوال بديل",
            originArea: "منطقة السكن الأصلية",
            displaceArea: "منطقة النزوح الحالية",
            totalCount: "عدد الأفراد الكلي",
            femaleCount: "عدد الإناث",
            maleCount: "عدد الذكور",
            walletOwner: "مالك المحفظة",
            walletId: "هوية المحفظة",
            walletPhone: "جوال المحفظة"
        };

        function only9Numbers(input) { input.value = input.value.replace(/\D/g, '').substring(0, 9); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function getAge(dob) {
            if (!dob) return { y: 0, m: 0 };
            const birth = new Date(dob);
            const now = new Date();
            let y = now.getFullYear() - birth.getFullYear();
            let m = now.getMonth() - birth.getMonth();
            if (m < 0) { y--; m += 12; }
            return { y, m };
        }

        // ===========================================
        //       (تم نقل منطق المصادقة للأعلى)
        // ===========================================
        
        function requestAdmin() { 
            document.getElementById('passwordModal').classList.remove('hidden'); 
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPass').value = '';
        }

        function setupAdminUI(email) {
            document.getElementById('roleTitle').innerText = 'أهلاً بك أيها المسؤول (' + email + ')';
            document.getElementById('adminAddBtn').classList.remove('hidden');
            document.getElementById('navExportBtn').classList.remove('hidden');
            document.getElementById('adminActions').classList.remove('hidden');
            document.getElementById('sensitiveFilters').classList.remove('hidden');
            document.getElementById('socialFilterDiv').classList.remove('hidden');
        }

        function setupVisitorUI() {
            document.getElementById('roleTitle').innerText = 'مرحباً بك، وضع المشاهدة';
            document.getElementById('adminAddBtn').classList.add('hidden');
            document.getElementById('navExportBtn').classList.add('hidden');
            document.getElementById('adminActions').classList.add('hidden');
            document.getElementById('sensitiveFilters').classList.add('hidden');
            document.getElementById('socialFilterDiv').classList.add('hidden');
        }

        // دالة تصفية البيانات (تم تعديلها للعمل مع window.families و window.currentRole)
        function runFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const ageF = document.getElementById('filterAge').value;
            const diseaseF = document.getElementById('filterDisease').value;
            const delegateF = document.getElementById('filterDelegate').value;
            const socialF = document.getElementById('filterSocial').value;

            let resultData = [];
            currentViewMode = 'family';

            const matchesSearch = (f) => (f.pName || "").toLowerCase().includes(search) || 
                                         (f.pId || "").includes(search) || 
                                         (f.pDelegate || "").toLowerCase().includes(search) ||
                                         (f.totalCount || "").toString().includes(search);

            if (window.currentRole === 'visitor') {
                 resultData = window.families.filter(f => {
                    const mSearch = matchesSearch(f);
                    const mDelegate = delegateF === 'all' || f.pDelegate === delegateF;
                    return mSearch && mDelegate;
                 }).map(f => ({
                    type: 'family',
                    familyId: f.id,
                    pName: f.pName,
                    pDelegate: f.pDelegate,
                    raw: f
                 }));
            } else {
                if (ageF !== 'all') {
                    currentViewMode = 'individual';
                    window.families.forEach(f => {
                        if (!matchesSearch(f)) return;
                        (f.members || []).forEach(m => {
                            const age = getAge(m.dob);
                            let match = false;
                            
                            // منطق الفرز العمري الجديد
                            if (ageF === '0-1' && age.y === 0) match = true;
                            if (ageF === '1-2' && age.y === 1) match = true;
                            if (ageF === '2-5' && age.y >= 2 && age.y <= 5) match = true;
                            if (ageF === '5-10' && age.y > 5 && age.y <= 10) match = true;
                            if (ageF === '10-17' && age.y > 10 && age.y <= 17) match = true;
                            if (ageF === '18-25' && age.y > 17 && age.y <= 25) match = true;
                            if (ageF === '26-40' && age.y > 25 && age.y <= 40) match = true;
                            if (ageF === '41-80' && age.y > 40 && age.y <= 80) match = true;

                            if (match) {
                                resultData.push({
                                    type: 'individual',
                                    familyId: f.id,
                                    targetName: m.name,
                                    targetId: m.idNum,
                                    targetAge: `${age.y} سنة`,
                                    relation: m.relation,
                                    pName: f.pName,
                                    pId: f.pId,
                                    wifeName: f.wifeName,
                                    wifeId: f.wifeId,
                                    pPhone: f.pPhone
                                });
                            }
                        });
                        
                        // فحص الأب والزوجة أيضاً
                        [ {name: f.pName, dob: f.pDob, id: f.pId, role: 'أب'}, 
                          {name: f.wifeName, dob: f.wifeDob, id: f.wifeId, role: 'زوجة'} ].forEach(p => {
                            const age = getAge(p.dob);
                            let match = false;

                            if (ageF === '0-1' && age.y === 0) match = true;
                            if (ageF === '1-2' && age.y === 1) match = true;
                            if (ageF === '2-5' && age.y >= 2 && age.y <= 5) match = true;
                            if (ageF === '5-10' && age.y > 5 && age.y <= 10) match = true;
                            if (ageF === '10-17' && age.y > 10 && age.y <= 17) match = true;
                            if (ageF === '18-25' && age.y > 17 && age.y <= 25) match = true;
                            if (ageF === '26-40' && age.y > 25 && age.y <= 40) match = true;
                            if (ageF === '41-80' && age.y > 40 && age.y <= 80) match = true;

                            if (match) {
                                resultData.push({
                                    type: 'individual',
                                    familyId: f.id,
                                    targetName: p.name,
                                    targetId: p.id,
                                    targetAge: `${age.y} سنة`,
                                    relation: p.role,
                                    pName: f.pName,
                                    pId: f.pId,
                                    wifeName: f.wifeName,
                                    wifeId: f.wifeId,
                                    pPhone: f.pPhone
                                });
                            }
                        });
                    });
                } else if (diseaseF !== 'all') {
                    currentViewMode = 'health';
                    window.families.forEach(f => {
                        if (!matchesSearch(f)) return;
                        (f.health || []).forEach(h => {
                            if (h.type === diseaseF) {
                                resultData.push({
                                    type: 'health',
                                    familyId: f.id,
                                    patientName: h.name,
                                    patientId: h.idNum,
                                    patientDob: h.dob, // إضافة تاريخ ميلاد المريض
                                    diseaseType: h.type,
                                    diseaseDesc: h.desc,
                                    pName: f.pName,
                                    pId: f.pId,
                                    wifeName: f.wifeName,
                                    wifeId: f.wifeId,
                                    pPhone: f.pPhone
                                });
                            }
                        });
                    });
                } else {
                    currentViewMode = 'family';
                    let filtered = window.families.filter(f => {
                        const mSearch = matchesSearch(f);
                        const mDelegate = delegateF === 'all' || f.pDelegate === delegateF;
                        const mSocial = socialF === 'all' || f.pSocial === socialF;
                        return mSearch && mDelegate && mSocial;
                    });
                    if (showDupsOnly) {
                        const idCounts = {};
                        window.families.forEach(f => idCounts[f.pId] = (idCounts[f.pId] || 0) + 1);
                        filtered = filtered.filter(f => idCounts[f.pId] > 1);
                    }
                    resultData = filtered.map(f => ({
                        type: 'family',
                        familyId: f.id,
                        pName: f.pName,
                        pId: f.pId,
                        wifeName: f.wifeName,
                        wifeId: f.wifeId,
                        pPhone: f.pPhone,
                        pDelegate: f.pDelegate,
                        pSocial: f.pSocial,
                        totalCount: f.totalCount,
                        raw: f 
                    }));
                }
            }

            currentViewData = resultData;
            renderTable(resultData);
            updateStats(window.families);
        }

        function updateStats(data) {
            document.getElementById('totalFamilies').innerText = data.length;
            let total = 0;
            data.forEach(f => total += parseInt(f.totalCount || 0));
            document.getElementById('totalPersons').innerText = total;

            const idCounts = {};
            let dups = 0;
            data.forEach(f => {
                idCounts[f.pId] = (idCounts[f.pId] || 0) + 1;
                if(idCounts[f.pId] === 2) dups++;
            });
            document.getElementById('totalDuplicates').innerText = dups;
        }

        function renderTable(data) {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (window.currentRole === 'visitor') {
                 thead.innerHTML = `
                    <tr class="bg-slate-50/50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b">
                        <th class="px-4 py-4 w-1/2">اسم رب الأسرة</th>
                        <th class="px-4 py-4 w-1/2">المندوب</th>
                    </tr>
                `;
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-all border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="px-4 py-4 font-bold text-slate-700">${row.pName}</td>
                        <td class="px-4 py-4"><span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">${row.pDelegate || '-'}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
                return;
            }

            let headersHTML = '';
            if (currentViewMode === 'individual') {
                headersHTML = `
                    <th class="px-4 py-4">اسم الفرد</th>
                    <th class="px-4 py-4">هوية الفرد</th>
                    <th class="px-4 py-4">العمر/الصلة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">رقم الجوال</th>
                    <th class="px-4 py-4 text-center">إجراءات</th>
                `;
            } else if (currentViewMode === 'health') {
                // تعديل ترويسة الجدول للحالات المرضية حسب الطلب
                headersHTML = `
                    <th class="px-4 py-4">اسم المريض</th>
                    <th class="px-4 py-4">هوية المريض</th>
                    <th class="px-4 py-4">تاريخ الميلاد</th>
                    <th class="px-4 py-4">نوع المرض</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">رقم الجوال</th>
                    <th class="px-4 py-4 text-center">إجراءات</th>
                `;
            } else {
                headersHTML = `
                    <th class="px-4 py-4">اسم الأب</th>
                    <th class="px-4 py-4">هوية الأب</th>
                    <th class="px-4 py-4">اسم الزوجة</th>
                    <th class="px-4 py-4">هوية الزوجة</th>
                    <th class="px-4 py-4">الجوال</th>
                    <th class="px-4 py-4">المندوب</th>
                    <th class="px-4 py-4">الحالة الاجتماعية</th>
                    <th class="px-4 py-4">العدد</th>
                    <th class="px-4 py-4 text-center">الإجراءات</th>
                `;
            }
            thead.innerHTML = `<tr class="bg-slate-50/50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b">${headersHTML}</tr>`;

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-all border-b border-slate-50";
                
                let rowHTML = '';
                const actions = `
                    <div class="flex items-center justify-center gap-2">
                        <button onclick="viewDetails('${row.familyId}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="تفاصيل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>
                        ${window.currentRole === 'admin' ? `
                            <button onclick="editFamily('${row.familyId}')" class="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition-all" title="تعديل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                            <button onclick="triggerDelete('${row.familyId}')" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-all" title="حذف"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        ` : ''}
                    </div>
                `;

                if (currentViewMode === 'individual') {
                    rowHTML = `
                        <td class="px-4 py-4 font-bold text-indigo-700">${row.targetName || '-'}</td>
                        <td class="px-4 py-4 font-mono">${row.targetId || '-'}</td>
                        <td class="px-4 py-4 text-xs font-bold text-slate-500">${row.targetAge} (${row.relation})</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.pName}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.pId}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.wifeId || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.pPhone}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                } else if (currentViewMode === 'health') {
                    // تعديل صفوف الجدول للحالات المرضية حسب الطلب
                    rowHTML = `
                        <td class="px-4 py-4 font-bold text-red-600">${row.patientName || '-'}</td>
                        <td class="px-4 py-4 font-mono">${row.patientId || '-'}</td>
                        <td class="px-4 py-4 font-mono">${row.patientDob || '-'}</td>
                        <td class="px-4 py-4 text-xs font-bold bg-red-50 text-red-600 rounded-lg">${row.diseaseType}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.pName}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.pId}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.wifeId || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${row.pPhone}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                } else {
                    rowHTML = `
                        <td class="px-4 py-4 font-bold text-slate-700">${row.pName}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">${window.currentRole === 'visitor' ? 'ID:••••' : row.pId}</td>
                        <td class="px-4 py-4">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">${window.currentRole === 'visitor' ? 'ID:••••' : (row.wifeId || '-')}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">0${window.currentRole === 'visitor' ? '••••' : row.pPhone}</td>
                        <td class="px-4 py-4"><span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">${row.pDelegate || '-'}</span></td>
                        <td class="px-4 py-4 text-xs font-bold">${row.pSocial || '-'}</td>
                        <td class="px-4 py-4 font-bold">${row.totalCount || 0}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                }

                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
        }

        function openForm() {
            document.getElementById('mainForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('membersList').innerHTML = '';
            document.getElementById('healthList').innerHTML = '';
            document.getElementById('modalTitle').innerText = 'إضافة بيانات عائلة';
            document.getElementById('formModal').classList.remove('hidden');
        }

        function addMemberRow(data = {}) {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 relative member-row";
            div.innerHTML = `
                <input type="text" placeholder="اسم الفرد" class="m-name border-none bg-slate-50 rounded-xl p-4 text-xs font-bold" value="${data.name || ''}">
                <select class="m-rel border-none bg-slate-50 rounded-xl p-4 text-xs font-bold">
                    ${['اخ', 'اخت', 'زوجة', 'ابن', 'ابنه', 'ام', 'اب', 'خاله', 'عمه', 'جد', 'جده', 'محتضنه'].map(r => `<option ${data.relation === r ? 'selected' : ''}>${r}</option>`).join('')}
                </select>
                <input type="date" class="m-dob border-none bg-slate-50 rounded-xl p-4 text-xs font-bold" value="${data.dob || ''}">
                <input type="text" maxlength="9" placeholder="رقم الهوية" class="m-id border-none bg-slate-50 rounded-xl p-4 text-xs font-mono font-bold" value="${data.idNum || ''}">
                <button type="button" onclick="this.parentElement.remove()" class="absolute -left-2 -top-2 bg-white text-red-500 w-8 h-8 rounded-full shadow-md border flex items-center justify-center font-black">×</button>
            `;
            document.getElementById('membersList').appendChild(div);
        }

        function addHealthRow(data = {}) {
            const div = document.createElement('div');
            div.className = "bg-red-50/20 p-6 rounded-3xl border border-red-100 relative health-row space-y-3";
            div.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <select class="h-type border-none bg-white rounded-xl p-4 text-xs font-bold">
                        ${['مرض مزمن', 'اعاقة سمعية', 'اعاقة حركية', 'اعاقة بصرية', 'اخرى'].map(t => `<option ${data.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                    </select>
                    <input type="text" placeholder="الاسم" class="h-name border-none bg-white rounded-xl p-4 text-xs font-bold" value="${data.name || ''}">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" placeholder="الهوية" maxlength="9" class="h-id border-none bg-white rounded-xl p-4 text-xs font-mono" value="${data.idNum || ''}">
                    <input type="text" placeholder="الجوال" maxlength="9" class="h-phone border-none bg-white rounded-xl p-4 text-xs font-mono" value="${data.phone || ''}">
                    <input type="date" class="h-dob border-none bg-white rounded-xl p-4 text-xs" value="${data.dob || ''}">
                </div>
                <textarea placeholder="تفاصيل المرض" class="h-desc w-full border-none bg-white rounded-xl p-4 text-xs" rows="2">${data.desc || ''}</textarea>
                <button type="button" onclick="this.parentElement.remove()" class="absolute -left-2 -top-2 bg-white text-red-500 w-8 h-8 rounded-full shadow-md border flex items-center justify-center font-black">×</button>
            `;
            document.getElementById('healthList').appendChild(div);
        }

        async function handleSave(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            
            const payload = {
                pName: document.getElementById('pName').value,
                pId: document.getElementById('pId').value,
                pDob: document.getElementById('pDob').value,
                pPhone: document.getElementById('pPhone').value,
                pSocial: document.getElementById('pSocial').value,
                wifeName: document.getElementById('wifeName').value,
                wifeId: document.getElementById('wifeId').value,
                wifeDob: document.getElementById('wifeDob').value,
                pDelegate: document.getElementById('pDelegate').value,
                pAltPhone: document.getElementById('pAltPhone').value,
                originArea: document.getElementById('originArea').value,
                displaceArea: document.getElementById('displaceArea').value,
                totalCount: document.getElementById('totalCount').value,
                maleCount: document.getElementById('maleCount').value,
                femaleCount: document.getElementById('femaleCount').value,
                walletOwner: document.getElementById('walletOwner').value,
                walletId: document.getElementById('walletId').value,
                walletPhone: document.getElementById('walletPhone').value,
                members: Array.from(document.querySelectorAll('.member-row')).map(r => ({
                    name: r.querySelector('.m-name').value,
                    relation: r.querySelector('.m-rel').value,
                    dob: r.querySelector('.m-dob').value,
                    idNum: r.querySelector('.m-id').value
                })),
                health: Array.from(document.querySelectorAll('.health-row')).map(r => ({
                    type: r.querySelector('.h-type').value,
                    name: r.querySelector('.h-name').value,
                    idNum: r.querySelector('.h-id').value,
                    phone: r.querySelector('.h-phone').value,
                    dob: r.querySelector('.h-dob').value,
                    desc: r.querySelector('.h-desc').value
                })),
                updatedAt: new Date().toISOString()
            };

            try {
                if (editId) {
                    await window.fs.updateDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "families", editId), payload);
                } else {
                    await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "families"), payload);
                }
                closeModal('formModal');
            } catch (err) { alert("خطأ في التخزين السحابي: " + err.message); }
        }

        async function editFamily(id) {
            const f = window.families.find(x => x.id === id);
            if(!f) return;
            openForm();
            document.getElementById('editId').value = f.id;
            document.getElementById('modalTitle').innerText = 'تعديل بيانات العائلة';
            
            Object.keys(f).forEach(key => {
                const el = document.getElementById(key);
                if(el && key !== 'members' && key !== 'health') el.value = f[key] || '';
            });

            if(f.members) f.members.forEach(m => addMemberRow(m));
            if(f.health) f.health.forEach(h => addHealthRow(h));
            
            document.getElementById('formModal').classList.remove('hidden');
        }

        function triggerDelete(id) {
            pendingDeleteId = id;
            document.getElementById('undoToast').classList.remove('hidden');
            deleteTimer = setTimeout(async () => {
                if(pendingDeleteId) {
                    await window.fs.deleteDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "families", pendingDeleteId));
                }
                document.getElementById('undoToast').classList.add('hidden');
                pendingDeleteId = null;
            }, 5000);
        }

        function cancelDelete() {
            clearTimeout(deleteTimer);
            pendingDeleteId = null;
            document.getElementById('undoToast').classList.add('hidden');
        }

        function viewDetails(id) {
            const f = window.families.find(x => x.id === id);
            if(!f) return;
            
            const pAge = getAge(f.pDob);
            const wAge = getAge(f.wifeDob);
            const isV = window.currentRole === 'visitor';

            const html = `
                <div class="flex items-center gap-8 mb-12">
                    <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center text-4xl text-white font-black shadow-xl shadow-indigo-100">${(f.pName || "?")[0]}</div>
                    <div>
                        <h2 class="text-4xl font-black text-slate-800">${f.pName || "غير متوفر"}</h2>
                        <p class="text-indigo-500 font-bold tracking-widest uppercase text-sm mt-2">مندوب التوزيع: ${f.pDelegate || "غير محدد"}</p>
                    </div>
                </div>
                ${isV ? '<p class="text-center text-slate-400 font-bold py-10">عذراً، التفاصيل الكاملة متاحة للمسؤولين فقط</p>' : `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
                    <div class="space-y-8">
                        <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4">المعلومات الشخصية</h3>
                        <div class="grid grid-cols-2 gap-y-6 text-sm">
                            <span class="text-slate-400">رقم الهوية:</span> <span class="font-mono font-bold">${f.pId || "-"}</span>
                            <span class="text-slate-400">تاريخ الميلاد:</span> <span class="font-bold">${f.pDob || "-"} (${pAge.y} سنة، ${pAge.m} شهر)</span>
                            <span class="text-slate-400">رقم الجوال:</span> <span class="font-mono font-bold">0${f.pPhone || "-"}</span>
                            <span class="text-slate-400">جوال بديل:</span> <span class="font-mono font-bold">0${f.pAltPhone || "-"}</span>
                            <span class="text-slate-400">الحالة الاجتماعية:</span> <span class="font-bold">${f.pSocial || "-"}</span>
                            <span class="text-slate-400">السكن الأصلي:</span> <span class="font-bold">${f.originArea || "-"}</span>
                            <span class="text-slate-400">منطقة النزوح:</span> <span class="font-bold">${f.displaceArea || "-"}</span>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4">بيانات الزوجة</h3>
                        <div class="grid grid-cols-2 gap-y-6 text-sm">
                            <span class="text-slate-400">الاسم:</span> <span class="font-bold">${f.wifeName || "غير محدد"}</span>
                            <span class="text-slate-400">الهوية:</span> <span class="font-mono font-bold">${f.wifeId || "-"}</span>
                            <span class="text-slate-400">تاريخ الميلاد:</span> <span class="font-bold">${f.wifeDob || "-"}</span>
                        </div>
                    </div>
                </div>
                <div class="mt-16">
                    <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4 mb-8">أفراد العائلة المضافين (${f.members?.length || 0})</h3>
                    <div class="bg-slate-50 rounded-[3rem] p-10 overflow-x-auto">
                        <table class="w-full text-right text-xs">
                            <thead class="text-slate-400 border-b border-slate-200">
                                <tr><th class="pb-4">الاسم</th><th class="pb-4">الصلة</th><th class="pb-4">تاريخ الميلاد</th><th class="pb-4">العمر</th><th class="pb-4">الهوية</th></tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${(f.members || []).map(m => {
                                    const age = getAge(m.dob);
                                    return `<tr><td class="py-4 font-bold text-slate-700">${m.name || "-"}</td><td>${m.relation || "-"}</td><td>${m.dob || "-"}</td><td>${age.y} سنة، ${age.m} شهر</td><td class="font-mono">${m.idNum || "-"}</td></tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mt-16">
                    <div class="p-10 bg-red-50 rounded-[3rem] border border-red-100">
                        <h3 class="text-red-600 font-black mb-6">الحالات الصحية</h3>
                        ${(f.health || []).map(h => `
                            <div class="mb-4 bg-white p-6 rounded-2xl shadow-sm">
                                <div class="flex justify-between font-black text-slate-800 mb-3 border-b pb-2">
                                    <span>${h.name || "بدون اسم"}</span>
                                    <span class="text-red-500 text-xs bg-red-50 px-2 py-1 rounded-lg">${h.type || "-"}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs text-slate-500 mb-3">
                                     <div><span class="text-slate-400">الهوية:</span> <span class="font-mono font-bold">${h.idNum || "-"}</span></div>
                                     <div><span class="text-slate-400">الجوال:</span> <span class="font-mono font-bold">${h.phone || "-"}</span></div>
                                     <div class="col-span-2"><span class="text-slate-400">الميلاد:</span> <span class="font-bold">${h.dob || "-"}</span></div>
                                </div>
                                <div class="text-[11px] text-slate-600 bg-slate-50 p-3 rounded-xl">
                                    <span class="font-bold block mb-1">التفاصيل:</span>
                                    ${h.desc || "لا يوجد تفاصيل إضافية"}
                                </div>
                            </div>
                        `).join('') || '<p class="text-xs text-red-300">لا يوجد سجلات مرضية</p>'}
                    </div>
                    <div class="p-10 bg-emerald-50 rounded-[3rem] border border-emerald-100">
                        <h3 class="text-emerald-600 font-black mb-6">المحفظة الإلكترونية</h3>
                        <div class="space-y-4 text-sm">
                            <div class="flex justify-between"><span>المالك:</span><span class="font-bold">${f.walletOwner || "-"}</span></div>
                            <div class="flex justify-between"><span>الهوية:</span><span class="font-mono">${f.walletId || "-"}</span></div>
                            <div class="flex justify-between"><span>الجوال:</span><span class="font-mono">0${f.walletPhone || "-"}</span></div>
                        </div>
                    </div>
                </div>
                `}
            `;
            document.getElementById('detailsContent').innerHTML = html;
            
            const actionContainer = document.getElementById('detailActions');
            actionContainer.innerHTML = ''; // مسح الأزرار القديمة

            if(!isV) {
                // زر تصدير الإكسل
                const exportBtn = document.createElement('button');
                exportBtn.className = "px-6 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 shadow-xl shadow-indigo-100 flex items-center gap-2";
                exportBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> تصدير إكسل`;
                exportBtn.onclick = () => exportSingleToExcel(f);
                actionContainer.appendChild(exportBtn);

                // زر الطباعة
                const printBtn = document.createElement('button');
                printBtn.className = "px-6 py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 shadow-xl flex items-center gap-2";
                printBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg> طباعة PDF`;
                printBtn.onclick = () => printFamilyDetails(f);
                actionContainer.appendChild(printBtn);
            }
            
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function downloadTemplate() {
            const headers = [
                "اسم رب الأسرة", "تاريخ ميلاد رب الأسرة", "هوية رب الأسرة", "رقم الجوال",
                "اسم الزوجة", "هوية الزوجة", "تاريخ ميلاد الزوجة", "الحالة الاجتماعية",
                "عدد الأفراد الكلي", "عدد الذكور", "عدد الإناث"
            ];
            for(let i=1; i<=10; i++) {
                headers.push(`اسم الفرد ${i}`, `صلة القرابة ${i}`, `تاريخ الميلاد الفرد ${i}`, `رقم الهوية الفرد ${i}`);
            }
            headers.push("منطقة السكن الأصلية", "منطقة النزوح", "المندوب", "جوال بديل");
            for(let i=1; i<=5; i++) {
                headers.push(`الاسم الحالة ${i}`, `رقم الهوية الحالة ${i}`, `رقم الجوال الحالة ${i}`, `نوع المرض ${i}`);
            }
            headers.push("اسم المالك المحفظة", "رقم الهوية المحفظة", "رقم الجوال المحفظة");

            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "النموذج_الشامل_للعائلات.xlsx");
        }

        async function importData(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = async (evt) => {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                let successCount = 0;

                for (let row of rawData) {
                    let obj = {
                        updatedAt: new Date().toISOString(),
                        pName: row["اسم رب الأسرة"] || "",
                        pDob: row["تاريخ ميلاد رب الأسرة"] || "",
                        pId: String(row["هوية رب الأسرة"] || ""),
                        pPhone: String(row["رقم الجوال"] || ""),
                        wifeName: row["اسم الزوجة"] || "",
                        wifeId: String(row["هوية الزوجة"] || ""),
                        wifeDob: row["تاريخ ميلاد الزوجة"] || "",
                        pSocial: row["الحالة الاجتماعية"] || "",
                        totalCount: row["عدد الأفراد الكلي"] || "",
                        maleCount: row["عدد الذكور"] || "",
                        femaleCount: row["عدد الإناث"] || "",
                        originArea: row["منطقة السكن الأصلية"] || "",
                        displaceArea: row["منطقة النزوح"] || "",
                        pDelegate: row["المندوب"] || "",
                        pAltPhone: String(row["جوال بديل"] || ""),
                        walletOwner: row["اسم المالك المحفظة"] || "",
                        walletId: String(row["رقم الهوية المحفظة"] || ""),
                        walletPhone: String(row["رقم الجوال المحفظة"] || "")
                    };

                    let members = [];
                    for(let i=1; i<=10; i++) {
                        if(row[`اسم الفرد ${i}`]) {
                            members.push({
                                name: row[`اسم الفرد ${i}`],
                                relation: row[`صلة القرابة ${i}`] || "",
                                dob: row[`تاريخ الميلاد الفرد ${i}`] || "",
                                idNum: String(row[`رقم الهوية الفرد ${i}`] || "")
                            });
                        }
                    }
                    obj.members = members;

                    let health = [];
                    for(let i=1; i<=5; i++) {
                        if(row[`الاسم الحالة ${i}`]) {
                            health.push({
                                name: row[`الاسم الحالة ${i}`],
                                idNum: String(row[`رقم الهوية الحالة ${i}`] || ""),
                                phone: String(row[`رقم الجوال الحالة ${i}`] || ""),
                                type: row[`نوع المرض ${i}`] || "",
                                desc: "" 
                            });
                        }
                    }
                    obj.health = health;

                    if(obj.pName && obj.pId) {
                        try {
                            await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "families"), obj);
                            successCount++;
                        } catch(err) { console.error("Import Error", err); }
                    }
                }
                alert(`تم استيراد ${successCount} عائلة بنجاح`);
                location.reload(); 
            };
            reader.readAsBinaryString(file);
        }

        function exportSingleToExcel(f) {
            // تجهيز مصفوفة البيانات لملف الإكسل بشكل مرتب
            const wb = XLSX.utils.book_new();
            const data = [];

            // 1. البيانات الأساسية (عنوان)
            data.push(["البيانات الأساسية للعائلة"]);
            data.push(["اسم رب الأسرة", f.pName || "", "رقم الهوية", f.pId || ""]);
            data.push(["تاريخ الميلاد", f.pDob || "", "رقم الجوال", f.pPhone || ""]);
            data.push(["الحالة الاجتماعية", f.pSocial || "", "المندوب", f.pDelegate || ""]);
            data.push(["اسم الزوجة", f.wifeName || "", "هوية الزوجة", f.wifeId || ""]);
            data.push(["تاريخ ميلاد الزوجة", f.wifeDob || "", "جوال بديل", f.pAltPhone || ""]);
            data.push(["السكن الأصلي", f.originArea || "", "منطقة النزوح", f.displaceArea || ""]);
            data.push(["إجمالي الأفراد", f.totalCount || 0, "عدد الذكور", f.maleCount || 0, "عدد الإناث", f.femaleCount || 0]);
            
            // فاصل
            data.push([]); 

            // 2. أفراد العائلة
            data.push(["أفراد العائلة المضافين"]);
            data.push(["الاسم", "الصلة", "تاريخ الميلاد", "العمر", "رقم الهوية"]);
            if(f.members && f.members.length > 0) {
                f.members.forEach(m => {
                    const age = getAge(m.dob);
                    data.push([
                        m.name || "",
                        m.relation || "",
                        m.dob || "",
                        `${age.y} سنة`,
                        m.idNum || ""
                    ]);
                });
            } else {
                data.push(["لا يوجد أفراد مضافين"]);
            }

            // فاصل
            data.push([]); 

            // 3. الحالات الصحية
            data.push(["الحالات الصحية الخاصة"]);
            data.push(["الاسم", "نوع الحالة", "رقم الهوية", "رقم الجوال", "تاريخ الميلاد", "التفاصيل"]);
            if(f.health && f.health.length > 0) {
                f.health.forEach(h => {
                    data.push([
                        h.name || "",
                        h.type || "",
                        h.idNum || "",
                        h.phone || "",
                        h.dob || "",
                        h.desc || ""
                    ]);
                });
            } else {
                data.push(["لا يوجد سجلات صحية"]);
            }

            // فاصل
            data.push([]); 

            // 4. المحفظة
            data.push(["بيانات المحفظة الإلكترونية"]);
            data.push(["اسم المالك", f.walletOwner || "", "رقم الهوية", f.walletId || "", "رقم الجوال", f.walletPhone || ""]);

            // إنشاء الشيت
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تنسيق بسيط للأعمدة (عرض)
            ws['!cols'] = [
                {wch: 25}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 40}
            ];

            XLSX.utils.book_append_sheet(wb, ws, "تقرير العائلة");
            XLSX.writeFile(wb, `بيانات_عائلة_${f.pName}.xlsx`);
        }

        function printFamilyDetails(f) {
            const pAge = getAge(f.pDob);
            
            // بناء محتوى الطباعة بتنسيق HTML نظيف جداً
            let printHTML = `
                <div class="print-container">
                    <div class="print-header">
                        <h1 class="print-title">استمارة بيانات عائلة</h1>
                        <p class="print-meta">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>

                    <div class="section-title">1. البيانات الأساسية</div>
                    <div class="info-grid">
                        <table class="print-table">
                            <tr>
                                <th>رب الأسرة</th>
                                <td>${f.pName || '-'}</td>
                            </tr>
                            <tr>
                                <th>رقم الهوية</th>
                                <td>${f.pId || '-'}</td>
                            </tr>
                            <tr>
                                <th>رقم الجوال</th>
                                <td>${f.pPhone || '-'}</td>
                            </tr>
                             <tr>
                                <th>تاريخ الميلاد</th>
                                <td>${f.pDob || '-'} (${pAge.y} سنة)</td>
                            </tr>
                        </table>
                        
                        <table class="print-table">
                             <tr>
                                <th>الزوجة</th>
                                <td>${f.wifeName || '-'}</td>
                            </tr>
                            <tr>
                                <th>هوية الزوجة</th>
                                <td>${f.wifeId || '-'}</td>
                            </tr>
                            <tr>
                                <th>السكن الأصلي</th>
                                <td>${f.originArea || '-'}</td>
                            </tr>
                            <tr>
                                <th>منطقة النزوح</th>
                                <td>${f.displaceArea || '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <table class="print-table" style="margin-top: 10px;">
                        <tr>
                            <th>المندوب</th>
                            <td>${f.pDelegate || '-'}</td>
                            <th>الحالة الاجتماعية</th>
                            <td>${f.pSocial || '-'}</td>
                            <th>عدد الأفراد</th>
                            <td>${f.totalCount || '0'}</td>
                        </tr>
                    </table>

                    <div class="section-title">2. أفراد العائلة (${f.members ? f.members.length : 0})</div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th style="width: 30%">الاسم</th>
                                <th style="width: 15%">الصلة</th>
                                <th style="width: 15%">تاريخ الميلاد</th>
                                <th style="width: 15%">العمر</th>
                                <th style="width: 25%">رقم الهوية</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if(f.members && f.members.length > 0) {
                f.members.forEach(m => {
                    const age = getAge(m.dob);
                    printHTML += `
                        <tr>
                            <td>${m.name || '-'}</td>
                            <td>${m.relation || '-'}</td>
                            <td>${m.dob || '-'}</td>
                            <td>${age.y} سنة</td>
                            <td>${m.idNum || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                printHTML += `<tr><td colspan="5" style="text-align: center; padding: 15px;">لا يوجد أفراد مضافين</td></tr>`;
            }

            printHTML += `
                        </tbody>
                    </table>

                    <div class="section-title">3. الحالات الصحية</div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th style="width: 25%">الاسم</th>
                                <th style="width: 20%">نوع المرض</th>
                                <th style="width: 20%">رقم الهوية</th>
                                <th style="width: 35%">التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

             if(f.health && f.health.length > 0) {
                f.health.forEach(h => {
                    printHTML += `
                        <tr>
                            <td>${h.name || '-'}</td>
                            <td>${h.type || '-'}</td>
                            <td>${h.idNum || '-'}</td>
                            <td>${h.desc || '-'}</td>
                        </tr>
                    `;
                });
            } else {
                printHTML += `<tr><td colspan="4" style="text-align: center; padding: 15px;">لا يوجد حالات صحية مسجلة</td></tr>`;
            }

            printHTML += `
                        </tbody>
                    </table>

                     <div class="section-title">4. المحفظة الإلكترونية</div>
                    <table class="print-table">
                        <tr>
                            <th width="15%">اسم المالك</th>
                            <td width="35%">${f.walletOwner || '-'}</td>
                            <th width="15%">رقم الهوية</th>
                            <td width="35%">${f.walletId || '-'}</td>
                        </tr>
                        <tr>
                             <th>رقم الجوال</th>
                             <td colspan="3">${f.walletPhone || '-'}</td>
                        </tr>
                    </table>
                </div>
            `;

            // حقن المحتوى في منطقة الطباعة
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = printHTML;
            
            // تنفيذ الطباعة
            window.print();
        }

        function exportCurrentView() {
            let dataForExcel = [];

            if (currentViewMode === 'individual') {
                dataForExcel = currentViewData.map(d => ({
                    "اسم الفرد": d.targetName,
                    "هوية الفرد": d.targetId,
                    "العمر/الصلة": `${d.targetAge} (${d.relation})`,
                    "اسم الأب": d.pName,
                    "هوية الأب": d.pId,
                    "اسم الزوجة": d.wifeName,
                    "هوية الزوجة": d.wifeId,
                    "رقم الجوال": d.pPhone
                }));
            } else if (currentViewMode === 'health') {
                dataForExcel = currentViewData.map(d => ({
                    "اسم المريض": d.patientName,
                    "هوية المريض": d.patientId, // تم إضافة الهوية هنا
                    "تاريخ الميلاد": d.patientDob, // تم إضافة تاريخ الميلاد هنا
                    "نوع المرض": d.diseaseType,
                    "تفاصيل المرض": d.diseaseDesc,
                    "اسم الأب": d.pName,
                    "هوية الأب": d.pId,
                    "اسم الزوجة": d.wifeName,
                    "هوية الزوجة": d.wifeId,
                    "رقم الجوال": d.pPhone
                }));
            } else {
                dataForExcel = currentViewData.map(d => ({
                    "اسم الأب": d.pName,
                    "هوية الأب": d.pId,
                    "اسم الزوجة": d.wifeName,
                    "هوية الزوجة": d.wifeId,
                    "رقم الجوال": d.pPhone,
                    "المندوب": d.pDelegate,
                    "الحالة الاجتماعية": d.pSocial,
                    "إجمالي الأفراد": d.totalCount
                }));
            }

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Export");
            XLSX.writeFile(wb, "تصدير_البيانات.xlsx");
        }

        function openExportModal() {
            const container = document.getElementById('exportFieldCheckboxes');
            container.innerHTML = '';
            Object.keys(FIELD_MAP).forEach(k => {
                container.innerHTML += `
                    <label class="flex items-center gap-3 p-4 bg-white rounded-2xl border border-slate-100 hover:border-indigo-200 cursor-pointer transition-all">
                        <input type="checkbox" value="${k}" checked class="w-5 h-5 rounded-lg text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-bold text-slate-600">${FIELD_MAP[k]}</span>
                    </label>
                `;
            });
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function runCustomExport() {
            const selected = Array.from(document.querySelectorAll('#exportFieldCheckboxes input:checked')).map(i => i.value);
            const data = window.families.map(f => {
                let obj = {};
                selected.forEach(k => obj[FIELD_MAP[k]] = f[k] || "");
                return obj;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CustomExport");
            XLSX.writeFile(wb, "تصدير_مخصص.xlsx");
            closeModal('exportModal');
        }

        function toggleDuplicateFilter() {
            showDupsOnly = !showDupsOnly;
            document.getElementById('dupIconBox').className = showDupsOnly 
                ? "w-16 h-16 bg-red-600 rounded-2xl flex items-center justify-center text-white" 
                : "w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-600";
            runFilters();
        }

        window.requestAdmin = requestAdmin;
        window.closeModal = closeModal;
        window.openForm = openForm;
        window.addMemberRow = addMemberRow;
        window.addHealthRow = addHealthRow;
        window.handleSave = handleSave;
        window.viewDetails = viewDetails;
        window.editFamily = editFamily;
        window.triggerDelete = triggerDelete;
        window.cancelDelete = cancelDelete;
        window.runFilters = runFilters;
        window.toggleDuplicateFilter = toggleDuplicateFilter;
        window.downloadTemplate = downloadTemplate;
        window.importData = importData;
        window.exportCurrentView = exportCurrentView;
        window.openExportModal = openExportModal;
        window.runCustomExport = runCustomExport;
        window.printFamilyDetails = printFamilyDetails;
    </script>
</body>
</html>