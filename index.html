<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة إدارة البيانات للنازحين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1); border-color: #6366f1; }
        .modal-anim { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        th, td { white-space: nowrap; }

        /* Multi-select Styles */
        .multiselect-container { position: relative; width: 100%; }
        .multiselect-btn { text-align: right; display: flex; justify-content: space-between; align-items: center; }
        .multiselect-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; max-height: 250px; overflow-y: auto; padding: 0.5rem; margin-top: 5px; }
        .multiselect-options.show { display: block; }
        .multiselect-option { display: flex; items-center; gap: 8px; padding: 8px; cursor: pointer; border-radius: 0.5rem; transition: background 0.2s; }
        .multiselect-option:hover { background-color: #f1f5f9; }
        .multiselect-option input[type="checkbox"] { width: 16px; height: 16px; accent-color: #4f46e5; cursor: pointer; }

        @media print {
            body * { visibility: hidden; }
            #authOverlay, #mainUI, #formModal, #detailsModal, #exportModal, #userParamsModal, #editCredsModal, nav { display: none !important; }
            #printArea, #printArea * { visibility: visible; display: block; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; font-size: 12pt; }
            @page { size: A4; margin: 1cm; }
            .print-container { width: 100%; direction: rtl; }
            .print-header { text-align: center; border-bottom: 3px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .print-title { font-size: 24pt; font-weight: 900; margin: 0; }
            .print-meta { font-size: 10pt; color: #555; margin-top: 5px; }
            .section-title { font-size: 16pt; font-weight: bold; background-color: #eee !important; -webkit-print-color-adjust: exact; padding: 8px 10px; margin-top: 25px; margin-bottom: 10px; border-right: 5px solid #000; border-bottom: 1px solid #ccc; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 6px 10px; text-align: right; font-size: 11pt; }
            .print-table th { background-color: #f3f3f3 !important; -webkit-print-color-adjust: exact; font-weight: bold; width: 20%; white-space: nowrap; }
            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxI5hPvlddgn9aZUrewesDbg8YSD7bEnk",
            authDomain: "mosadata-18521.firebaseapp.com",
            projectId: "mosadata-18521",
            storageBucket: "mosadata-18521.firebasestorage.app",
            messagingSenderId: "517965913092",
            appId: "1:517965913092:web:39db81b21739cef58e6951",
            measurementId: "G-C00LHCKEG7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "mosadata-18521";

        window.db = db;
        window.fs = { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, where, getDocs, setDoc };
        window.appId = appId;
        window.auth = auth;

        window.currentUserData = null;

        // ===========================================
        //       نظام المصادقة
        // ===========================================

        async function checkPersistentLogin() {
            const sessionString = localStorage.getItem('dbUserSession');
            if (!sessionString) {
                return false;
            }

            const { userId, expiry } = JSON.parse(sessionString);

            if (Date.now() > expiry) {
                localStorage.removeItem('dbUserSession');
                return false;
            }

            try {
                const userDocRef = window.fs.doc(window.db, "app_users", userId);
                const userDoc = await window.fs.getDoc(userDocRef);

                if (!userDoc.exists() || userDoc.data().isDisabled) {
                    localStorage.removeItem('dbUserSession');
                    return false;
                }
                
                const newExpiry = Date.now() + (60 * 60 * 1000); // 1 hour sliding expiry
                localStorage.setItem('dbUserSession', JSON.stringify({ userId, expiry: newExpiry }));
                
                await window.fs.updateDoc(userDocRef, {
                    lastLogin: new Date().toISOString(),
                    isOnline: true
                });

                const userData = userDoc.data();
                window.currentUserData = {
                    id: userId,
                    name: userData.name,
                    username: userData.username,
                    role: userData.role,
                    permissions: userData.permissions || [],
                    type: "db_user"
                };
                handleLoginSuccess();
                return true;
            } catch (e) {
                console.error("Persistent login check failed", e);
                localStorage.removeItem('dbUserSession');
                return false;
            }
        }

        onAuthStateChanged(auth, async (user) => { // This handles Google Auth persistence
            if (user) {
                window.currentUserData = {
                    name: "المدير الرئيسي",
                    username: user.email,
                    role: "super_admin",
                    permissions: ["add", "edit", "remove", "view", "manage_users", "export", "view_all"],
                    type: "google_auth"
                };
                handleLoginSuccess();
            } else {
                // If no Google user, check for our custom persistent session
                const customSessionActive = await checkPersistentLogin();
                if (!customSessionActive) {
                    document.getElementById('authOverlay').classList.remove('hidden');
                }
            }
        });

        window.unifiedLogin = async function() {
            const userOrEmail = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.classList.add('hidden');

            if(!userOrEmail || !pass) {
                errorDiv.innerText = "يرجى تعبئة جميع الحقول";
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                if(userOrEmail.includes('@')) {
                    await signInWithEmailAndPassword(auth, userOrEmail, pass);
                    return;
                }

                const q = query(collection(db, "app_users"), where("username", "==", userOrEmail));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("User not found");
                }

                let userData = null;
                let docId = null;
                
                querySnapshot.forEach((doc) => {
                    if (doc.data().password === pass) {
                        userData = doc.data();
                        docId = doc.id;
                    }
                });

                if (!userData) {
                    throw new Error("Wrong password");
                }

                if (userData.isDisabled) {
                    errorDiv.innerText = "هذا الحساب معطل، يرجى مراجعة المسؤول";
                    errorDiv.classList.remove('hidden');
                    return;
                }

                await updateDoc(doc(db, "app_users", docId), {
                    lastLogin: new Date().toISOString(),
                    isOnline: true
                });

                window.currentUserData = {
                    id: docId,
                    name: userData.name,
                    username: userData.username,
                    role: userData.role,
                    permissions: userData.permissions || [],
                    type: "db_user"
                };

                // حفظ الجلسة في localStorage لمدة ساعة
                const session = {
                    userId: docId,
                    expiry: Date.now() + (60 * 60 * 1000) // 1 hour
                };
                localStorage.setItem('dbUserSession', JSON.stringify(session));

                handleLoginSuccess();

            } catch (error) {
                // محاولة تسجيل الدخول كمستفيد (فرد)
                try {
                    const benQ = query(collection(db, "artifacts", appId, "public", "data", "families"), where("pId", "==", userOrEmail));
                    const benSnap = await getDocs(benQ);
                    
                    let benData = null;
                    let benId = null;

                    benSnap.forEach((doc) => {
                        // التحقق من رقم الجوال ككلمة مرور
                        if (doc.data().pPhone === pass) {
                            benData = doc.data();
                            benId = doc.id;
                        }
                    });

                    if (!benData) throw new Error("Beneficiary not found or wrong phone");

                    window.currentUserData = {
                        id: benId,
                        name: benData.pName,
                        username: benData.pId,
                        role: "beneficiary", // دور جديد
                        permissions: ["edit_self"],
                        type: "beneficiary_auth"
                    };
                    handleLoginSuccess();

                } catch (benError) {
                    console.error("Login Error:", error, benError);
                    errorDiv.innerText = "بيانات الدخول غير صحيحة (تأكد من الهوية والجوال)";
                    errorDiv.classList.remove('hidden');
                }
            }
        };

        function handleLoginSuccess() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainUI').classList.remove('hidden');
            setupUIBasedOnRole();
            initDataListener();
        }

        function setupUIBasedOnRole() {
            const u = window.currentUserData;
            document.getElementById('roleTitle').innerText = `أهلاً بك، ${u.name}`;

            const settingsBtn = document.getElementById('navSettingsBtn');
            const homeBtn = document.getElementById('navHomeBtn');
            const benBtn = document.getElementById('navBeneficiariesBtn');
            
            // إخفاء/إظهار واجهة المستفيد الخاصة
            if (u.role === 'beneficiary') {
                document.querySelector('nav').classList.add('hidden'); // إخفاء القائمة الجانبية
                document.getElementById('adminDashboard').classList.add('hidden'); // إخفاء لوحة التحكم الرئيسية
                document.getElementById('beneficiaryDashboard').classList.remove('hidden'); // إظهار لوحة المستفيد
                renderBeneficiaryView();
                return; // توقف هنا للمستفيد
            }

            // الوضع الطبيعي للموظفين والمدراء
            document.querySelector('nav').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('beneficiaryDashboard').classList.add('hidden');

            if (u.role === 'super_admin') {
                settingsBtn.classList.remove('hidden');
                homeBtn.classList.add('hidden');
            } else {
                settingsBtn.classList.add('hidden');
                homeBtn.classList.remove('hidden');
            }

            if (u.role === 'super_admin' || u.role === 'admin' || u.role === 'employee') {
                benBtn.classList.remove('hidden');
            } else {
                benBtn.classList.add('hidden');
            }

            const canAdd = u.permissions.includes('add');
            // التعديل هنا: تمكين التصدير إذا كان المدير الرئيسي أو لديه صلاحية export
            const canExport = u.role === 'super_admin' || u.role === 'admin' || u.permissions.includes('export');
            const actionsGroup = document.getElementById('navActionsGroup');
            
            if(canAdd) document.getElementById('adminAddBtn').classList.remove('hidden');
            else document.getElementById('adminAddBtn').classList.add('hidden');

            // التحكم في ظهور زر التصدير في القائمة الجانبية
            if(canExport) document.getElementById('navExportBtn').classList.remove('hidden');
            else document.getElementById('navExportBtn').classList.add('hidden');

            if(canAdd || canExport) actionsGroup.classList.remove('hidden');
            else actionsGroup.classList.add('hidden');

            // التحكم في ظهور أزرار الإجراءات الإدارية (قالب، استيراد، تصدير الفرز)
            if(canExport) {
                document.getElementById('adminActions').classList.remove('hidden');
                document.getElementById('adminActions').classList.add('flex'); // التأكد من تفعيل ال flex
            } else {
                document.getElementById('adminActions').classList.add('hidden');
                document.getElementById('adminActions').classList.remove('flex');
            }
            
            // الفلاتر تظهر للجميع
            document.getElementById('sensitiveFilters').classList.remove('hidden');
            document.getElementById('socialFilterDiv').classList.remove('hidden');
        }

        window.logout = async function() {
            try {
                if (window.currentUserData && window.currentUserData.type === 'db_user') {
                    await updateDoc(doc(db, "app_users", window.currentUserData.id), {
                        isOnline: false
                    });
                }
                localStorage.removeItem('dbUserSession');
                await signOut(auth);
                window.currentUserData = null;
                location.reload();
            } catch (error) {
                console.error("Logout Error", error);
                location.reload();
            }
        };

        function initDataListener() {
            if (window.currentUserData && window.currentUserData.role === 'beneficiary') {
                // للمستفيد: استمع فقط لملفه الشخصي
                onSnapshot(doc(db, "artifacts", appId, "public", "data", "families", window.currentUserData.id), (doc) => {
                    if (doc.exists()) {
                        window.families = [{ id: doc.id, ...doc.data() }];
                        renderBeneficiaryView(); // تحديث العرض عند تغير البيانات
                    } else {
                        alert("لم يعد الملف موجوداً");
                        logout();
                    }
                });
            } else {
                // للمدراء: استمع للكل
                const q = query(
                    collection(db, "artifacts", appId, "public", "data", "families"),
                    orderBy("updatedAt", "desc")
                );
                onSnapshot(q, (snapshot) => {
                    window.families = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateDelegateFilterOptions();
                    updateSocialFilterOptions();
                    runFilters();
                }, (err) => console.error("Firebase Snapshot Error", err));
            }
        }

    </script>
</head>
<body class="custom-scroll">

    <div id="printArea" class="hidden"></div>

    <div id="authOverlay" class="fixed inset-0 bg-slate-900 z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl p-10 w-full max-w-md text-center modal-anim">
            <div class="mb-8">
                <div class="bg-indigo-600 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-indigo-200">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <h1 class="text-3xl font-black text-slate-800">بوابة الدخول</h1>
                <p class="text-slate-400 mt-2">نظام إدارة البيانات المركزي</p>
            </div>
            
            <div class="space-y-4 text-right">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 mr-1">اسم المستخدم / رقم الهوية (هوية رب الأسرة)</label>
                    <input type="text" id="loginUser" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-left text-sm font-bold focus:ring-2 focus:ring-indigo-500" placeholder="Username / ID">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 mr-1">كلمة المرور / رقم الجوال (بدون 0)</label>
                    <input type="password" id="loginPass" class="w-full p-4 bg-slate-50 border-none rounded-2xl text-center text-xl tracking-widest focus:ring-2 focus:ring-indigo-500" placeholder="•••••••• / Phone">
                </div>
                <div id="loginError" class="text-red-500 text-xs font-bold hidden text-center"></div>
                
                <button onclick="unifiedLogin()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold hover:bg-black transition-all flex items-center justify-center gap-3 shadow-lg mt-4">
                    تسجيل الدخول
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                </button>
                <a href="https://chat.whatsapp.com/KMdH5zPM3JQBTpWuXUhazt" target="_blank" class="block w-full bg-emerald-50 text-emerald-600 py-4 rounded-2xl font-bold hover:bg-emerald-100 transition-all flex items-center justify-center gap-2 mt-4 text-sm shadow-sm">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    انضم لمجموعة الواتس بالمخيم
                </a>
            </div>
        </div>
    </div>

    <div id="mainUI" class="hidden min-h-screen">
        <nav class="fixed bottom-0 left-0 right-0 md:top-0 md:right-0 md:h-screen md:w-24 bg-white border-t md:border-t-0 md:border-l border-slate-200 z-[500] flex md:flex-col items-center justify-between p-2 md:py-6">
            
            <div class="hidden md:flex mb-6">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-100 font-black text-xl">DB</div>
            </div>
            
            <div class="flex md:flex-col items-center gap-6 w-full md:w-auto justify-center md:justify-start flex-1">
                
                <div class="flex md:flex-col gap-2 bg-slate-50/80 p-2 rounded-[1.5rem] border border-slate-100">
                    <button id="navHomeBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="hidden p-3 rounded-xl text-slate-400 hover:bg-white hover:text-indigo-600 hover:shadow-sm transition-all" title="الرئيسية">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    </button>
                    
                    <button id="navBeneficiariesBtn" onclick="openBeneficiaries()" class="hidden p-3 rounded-xl text-slate-400 hover:bg-white hover:text-emerald-600 hover:shadow-sm transition-all" title="المستفيدين والأرشفة">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    </button>
                </div>

                <div id="navActionsGroup" class="flex md:flex-col gap-2 bg-indigo-50/50 p-2 rounded-[1.5rem] border border-indigo-100 hidden">
                    <button onclick="openForm()" id="adminAddBtn" class="hidden p-3 rounded-xl bg-indigo-600 text-white shadow-md shadow-indigo-200 hover:scale-105 transition-all" title="إضافة جديد">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    </button>
                    <button id="navExportBtn" onclick="openExportModal()" class="hidden p-3 rounded-xl text-indigo-400 hover:bg-white hover:text-indigo-700 hover:shadow-sm transition-all" title="تصدير">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    </button>
                </div>

                <button id="navSettingsBtn" onclick="openUserManagement()" class="hidden p-4 rounded-2xl bg-slate-800 text-white shadow-lg shadow-slate-200 hover:bg-black transition-all" title="إدارة المستخدمين">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
            
            <div class="flex md:flex-col items-center gap-3 mt-auto relative">
                <div id="personalSettingsMenu" class="hidden absolute bottom-full left-0 mb-3 md:bottom-0 md:right-full md:mr-4 md:left-auto md:mb-0 bg-white border border-slate-100 shadow-2xl rounded-2xl p-2 w-56 z-[600] modal-anim origin-bottom-left">
                    <button onclick="openMyProfile()" class="w-full text-right p-3 rounded-xl text-sm font-bold text-slate-600 hover:bg-amber-50 hover:text-amber-600 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                        تغيير كلمة المرور
                    </button>
                    <button onclick="logout()" class="w-full text-right p-3 rounded-xl text-sm font-bold text-red-400 hover:bg-red-50 hover:text-red-600 transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        تسجيل خروج
                    </button>
                </div>
                <button onclick="togglePersonalSettings()" class="p-3 rounded-xl text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all" title="الإعدادات الشخصية">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
            </div>
        </nav>

        <main class="pb-24 md:pb-8 md:pr-24 min-h-screen">
            <!-- واجهة المدراء والموظفين -->
            <div id="adminDashboard" class="max-w-[95%] mx-auto p-4 md:p-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                    <div>
                        <h1 class="text-3xl font-black text-slate-800">لوحة التحكم</h1>
                        <p id="roleTitle" class="text-slate-500 font-medium">مرحباً بك</p>
                    </div>
                    <div id="syncStatus" class="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold animate-pulse">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> متصل بالسحابة
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5">
                        <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">إجمالي الأفراد</p><h2 id="totalPersons" class="text-3xl font-black text-slate-800">0</h2></div>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5">
                        <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">إجمالي العائلات</p><h2 id="totalFamilies" class="text-3xl font-black text-slate-800">0</h2></div>
                    </div>
                    <button onclick="toggleDuplicateFilter()" class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center gap-5 hover:border-red-300 transition-all text-right group">
                        <div id="dupIconBox" class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-600 group-hover:bg-red-600 group-hover:text-white transition-all"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 15c-.77 1.333.192 3 1.732 3z"/></svg></div>
                        <div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider">هويات مكررة</p><h2 id="totalDuplicates" class="text-3xl font-black text-red-600">0</h2></div>
                    </button>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm mb-8">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end">
                        <div class="lg:col-span-1 relative">
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">بحث ذكي (اسم، هوية، مندوب)</label>
                            <input type="text" id="searchInput" oninput="runFilters()" class="w-full bg-slate-50 border-none rounded-2xl p-4 pr-12 text-sm input-focus" placeholder="بحث...">
                            <svg class="w-6 h-6 text-slate-300 absolute right-4 top-11" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        
                        <div class="contents" id="sensitiveFilters">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">حسب العدد (استخراج أسر)</label>
                                <div class="multiselect-container" id="filterCount-container">
                                    <button onclick="toggleMultiSelect('filterCount')" class="multiselect-btn w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 hover:bg-slate-100 transition-all">
                                        <span id="filterCount-label">اختيار العدد...</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div id="filterCount-options" class="multiselect-options custom-scroll">
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="1"> 1</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="2"> 2</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="3"> 3</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="4"> 4</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="5"> 5</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="6"> 6</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="7"> 7</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="8"> 8</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="9"> 9</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="10"> 10</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="11"> 11</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="12"> 12</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="13"> 13</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="14"> 14</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="15"> 15</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="16"> 16</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="17"> 17</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="18"> 18</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="19"> 19</label>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">حسب العمر (استخراج أفراد)</label>
                                <div class="multiselect-container" id="filterAge-container">
                                    <button onclick="toggleMultiSelect('filterAge')" class="multiselect-btn w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 hover:bg-slate-100 transition-all">
                                        <span id="filterAge-label">اختيار الفئات العمرية...</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div id="filterAge-options" class="multiselect-options custom-scroll">
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="0-1"> 0 - 1 سنة</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="1-2"> 1 - 2 سنة</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="2-5"> 2 - 5 سنوات</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="5-10"> 5 - 10 سنوات</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="10-17"> 10 - 17 سنة</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="18-25"> 18 - 25 سنة</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="26-40"> 26 - 40 سنة</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="41-80"> 41 - 80 سنة</label>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">حسب المرض (استخراج أفراد)</label>
                                <div class="multiselect-container" id="filterDisease-container">
                                    <button onclick="toggleMultiSelect('filterDisease')" class="multiselect-btn w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 hover:bg-slate-100 transition-all">
                                        <span id="filterDisease-label">اختيار الحالات...</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div id="filterDisease-options" class="multiselect-options custom-scroll">
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="مرض مزمن"> مرض مزمن</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="اعاقة سمعية"> إعاقة سمعية</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="اعاقة حركية"> إعاقة حركية</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="اعاقة بصرية"> إعاقة بصرية</label>
                                        <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="اخرى"> اخرى</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 items-end mt-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">المندوب (بيانات عائلية)</label>
                            <div class="multiselect-container" id="filterDelegate-container">
                                <button onclick="toggleMultiSelect('filterDelegate')" class="multiselect-btn w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer">
                                    <span id="filterDelegate-label">كل المناديب</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="filterDelegate-options" class="multiselect-options custom-scroll">
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="موسى"> موسى</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="نبيل"> نبيل</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="عبدالحميد"> عبدالحميد</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="محمد عادل"> محمد عادل</label>
                                </div>
                            </div>
                        </div>
                        <div id="socialFilterDiv">
                            <label class="block text-xs font-bold text-slate-400 mb-2 mr-2">الحالة الاجتماعية (بيانات عائلية)</label>
                            <div class="multiselect-container" id="filterSocial-container">
                                <button onclick="toggleMultiSelect('filterSocial')" class="multiselect-btn w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold text-slate-600 appearance-none cursor-pointer">
                                    <span id="filterSocial-label">كل الحالات</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="filterSocial-options" class="multiselect-options custom-scroll">
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="متزوج"> متزوج</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="ارمله"> ارمله</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="مطلقة"> مطلقة</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="مهجورة"> مهجورة</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="اعزب"> اعزب</label>
                                    <label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="أيتام"> أيتام</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-2 flex gap-3 hidden" id="adminActions">
                            <button onclick="downloadTemplate()" class="flex-1 bg-white border border-slate-200 text-slate-600 p-4 rounded-2xl text-xs font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2">
                                تحميل النموذج
                            </button>
                            <button onclick="openImportModal()" class="flex-1 bg-indigo-50 text-indigo-600 p-4 rounded-2xl text-xs font-bold hover:bg-indigo-100 transition-all flex items-center justify-center gap-2">
                                استيراد إكسل
                            </button>
                            <button onclick="openMainExportModal()" class="flex-1 bg-emerald-600 text-white p-4 rounded-2xl text-xs font-bold hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100 flex items-center justify-center gap-2">
                                تصدير الفرز
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] border border-slate-100 shadow-xl overflow-hidden">
                    <div id="bulkActionsBar" class="hidden bg-red-50 p-4 flex justify-between items-center border-b border-red-100">
                        <span class="text-red-600 font-bold text-sm">تم تحديد <span id="selectedMainCount">0</span> عنصر</span>
                        <button onclick="deleteSelectedRows()" class="bg-red-600 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-700 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            إزالة الأسماء المحددة
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead id="tableHeader" class="bg-slate-50/50 text-slate-400 text-xs font-bold uppercase tracking-widest border-b"></thead>
                            <tbody id="tableBody" class="divide-y divide-slate-50 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- واجهة المستفيد (الأفراد) -->
            <div id="beneficiaryDashboard" class="hidden max-w-4xl mx-auto p-6 md:p-12 min-h-screen flex flex-col justify-center">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-black text-slate-800">ملفي الشخصي</h1>
                        <p class="text-slate-500 mt-1">بوابة المستفيدين</p>
                    </div>
                    <button onclick="logout()" class="bg-red-50 text-red-500 px-6 py-3 rounded-2xl font-bold hover:bg-red-100 transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                        خروج
                    </button>
                </div>
                
                <div id="benProfileContent" class="bg-white rounded-[3rem] shadow-xl border border-slate-100 overflow-hidden">
                    <!-- سيتم تعبئة البيانات هنا -->
                </div>
            </div>
        </main>
    </div>

    <div id="userParamsModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1500] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl modal-anim overflow-hidden h-[85vh] flex flex-col">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-2xl font-black text-slate-800 flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-800 text-white rounded-xl flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
                    إعدادات الحسابات والمستخدمين
                </h2>
                <button onclick="closeModal('userParamsModal')" class="p-3 bg-white border rounded-xl hover:bg-red-50 hover:border-red-200 hover:text-red-500 transition-all">✕</button>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col md:flex-row">
                <div class="w-full md:w-64 bg-slate-50 border-l p-6 space-y-2">
                    <button onclick="switchUserTab('create')" id="tabBtn-create" class="w-full text-right p-4 rounded-xl font-bold text-slate-500 hover:bg-white hover:shadow-sm transition-all user-tab-active">إنشاء مستخدم جديد</button>
                    <button onclick="switchUserTab('list')" id="tabBtn-list" class="w-full text-right p-4 rounded-xl font-bold text-slate-500 hover:bg-white hover:shadow-sm transition-all">قائمة المستخدمين</button>
                    <button onclick="switchUserTab('trash')" id="tabBtn-trash" class="w-full text-right p-4 rounded-xl font-bold text-slate-500 hover:bg-white hover:shadow-sm transition-all">الحسابات المعطلة</button>
                </div>

                <div class="flex-1 p-8 overflow-y-auto custom-scroll bg-white relative">
                    <div id="tab-create" class="user-tab-content">
                        <form id="createUserForm" onsubmit="handleCreateUser(event)" class="space-y-6 max-w-lg mx-auto">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2">الاسم الكامل</label>
                                <input type="text" id="newUserName" required class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-2">اسم المستخدم (User)</label>
                                    <input type="text" id="newUserUser" required class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold font-mono">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-2">كلمة المرور</label>
                                    <input type="text" id="newUserPass" required class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold font-mono">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-2">نوع الحساب</label>
                                <select id="newUserRole" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold text-slate-600">
                                    <option value="admin">مدير (Admin)</option>
                                    <option value="employee">موظف (Employee)</option>
                                    <option value="viewer">مشاهد (Viewer)</option>
                                </select>
                            </div>

                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                <label class="block text-xs font-bold text-slate-400 mb-4">الصلاحيات الممنوحة</label>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="view" checked disabled class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold">مشاهدة البيانات (افتراضي)</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="add" class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold">إضافة بيانات جديدة</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="edit" class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold">تعديل البيانات الموجودة</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="remove" class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold">إزالة البيانات (نقل للمحذوفات)</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="export" class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold text-emerald-600">تصدير واستيراد البيانات (Excel/Template)</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" name="perms" value="view_all" class="w-5 h-5 rounded text-indigo-600">
                                        <span class="text-sm font-bold text-blue-600">مشاهدة كافة البيانات (تخطي الفلاتر)</span>
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all">حفظ المستخدم الجديد</button>
                        </form>
                    </div>

                    <div id="tab-list" class="user-tab-content hidden">
                        <table class="w-full text-right">
                            <thead class="text-xs text-slate-400 font-bold uppercase border-b bg-slate-50">
                                <tr>
                                    <th class="p-4 rounded-tr-xl">الاسم</th>
                                    <th class="p-4">User</th>
                                    <th class="p-4">النوع</th>
                                    <th class="p-4">آخر دخول</th>
                                    <th class="p-4">الحالة</th>
                                    <th class="p-4 text-center">تعطيل</th>
                                    <th class="p-4 rounded-tl-xl text-center">تعديل</th>
                                </tr>
                            </thead>
                            <tbody id="usersListBody" class="text-sm font-bold text-slate-700"></tbody>
                        </table>
                    </div>

                    <div id="tab-trash" class="user-tab-content hidden">
                        <div class="bg-red-50 p-4 rounded-xl mb-4 text-red-600 text-sm font-bold">
                            ⚠️ تنبيه: الحذف هنا نهائي ولا يمكن التراجع عنه.
                        </div>
                        <table class="w-full text-right">
                            <thead class="text-xs text-red-400 font-bold uppercase border-b bg-red-50/50">
                                <tr>
                                    <th class="p-4">الاسم</th>
                                    <th class="p-4">User</th>
                                    <th class="p-4">النوع</th>
                                    <th class="p-4 text-center">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="trashUsersBody" class="text-sm font-bold text-slate-700"></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="editCredsModal" class="fixed inset-0 bg-black/60 hidden z-[1600] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl modal-anim max-h-[90vh] overflow-y-auto custom-scroll">
            <h3 class="text-xl font-bold mb-6 text-slate-800 border-b pb-4">تحديث بيانات وصلاحيات المستخدم</h3>
            <form onsubmit="handleSaveCreds(event)" class="space-y-4">
                <input type="hidden" id="editCredsId">
                <div id="usernameEditField">
                    <label class="block text-xs font-bold text-slate-400 mb-2">اسم المستخدم (User)</label>
                    <input type="text" id="editCredsUser" class="w-full bg-slate-50 border-none rounded-xl p-3 font-mono font-bold text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2">كلمة المرور الجديدة</label>
                    <input type="text" id="editCredsPass" placeholder="أدخل كلمة مرور جديدة" class="w-full bg-slate-50 border-none rounded-xl p-3 font-mono font-bold text-sm">
                    <p class="text-[10px] text-slate-400 mt-1">اتركها فارغة إذا لم ترد التغيير</p>
                </div>
                
                <div id="editPermsContainer" class="bg-slate-50 p-4 rounded-xl border border-slate-100 mt-4">
                    <label class="block text-xs font-bold text-slate-400 mb-3">تعديل الصلاحيات</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="view" checked disabled class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold">مشاهدة البيانات</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="add" class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold">إضافة بيانات جديدة</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="edit" class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold">تعديل البيانات</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="remove" class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold">إزالة البيانات</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="export" class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold text-emerald-600">تصدير واستيراد البيانات</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="editPerms" value="view_all" class="w-4 h-4 rounded text-indigo-600">
                            <span class="text-xs font-bold text-blue-600">مشاهدة كافة البيانات</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">حفظ التغييرات</button>
                    <button type="button" onclick="closeModal('editCredsModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="formModal" class="fixed inset-0 bg-slate-900/60 hidden z-[1200] overflow-y-auto p-4 md:p-12 backdrop-blur-sm">
        <div class="bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl mx-auto modal-anim overflow-hidden">
            <div class="p-8 md:p-12 border-b border-slate-50 flex items-center justify-between">
                <div>
                    <h2 id="modalTitle" class="text-3xl font-black text-slate-800">إضافة بيانات عائلة</h2>
                    <p class="text-slate-400 text-sm mt-1">أدخل البيانات بدقة لضمان دقة الأرشفة</p>
                </div>
                <button onclick="closeModal('formModal')" class="p-4 bg-slate-50 text-slate-400 rounded-2xl hover:bg-red-50 hover:text-red-500 transition-all"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <form id="mainForm" onsubmit="handleSave(event)" class="p-8 md:p-12 space-y-12">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-400 mb-2">الاسم الرباعي لرب الأسرة</label>
                        <input type="text" id="pName" required class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">رقم الهوية (هوية الاب)</label>
                        <input type="text" id="pId" maxlength="9" required oninput="only9Numbers(this)" class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-mono tracking-widest font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">اصدار الهوية</label>
                        <input type="text" id="pIdIssue" class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">رقم الجوال (بدون 0)</label>
                        <input type="text" id="pPhone" maxlength="9" required oninput="only9Numbers(this)" placeholder="59XXXXXXX" class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-mono font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الميلاد</label>
                        <input type="date" id="pDob" required class="w-full bg-slate-50 border-none rounded-2xl p-5 input-focus text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-2">الحالة الاجتماعية</label>
                        <select id="pSocial" onchange="calculateFamilyCounts()" class="w-full bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                            <option>متزوج</option><option>ارمله</option><option>مطلقة</option><option>مهجورة</option><option>اعزب</option><option>أيتام</option>
                        </select>
                    </div>
                </div>

                <div class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100">
                    <h3 class="text-slate-800 font-bold mb-6 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM6 8a2 2 0 11-4 0 2 2 0 014 0zM11 18a6 6 0 00-12 0c0 .099.01.196.03.291A5.985 5.985 0 014 13.06V11a2 2 0 10-4 0v2.06A8 8 0 0015 18z"></path></svg>
                        بيانات الزوجة
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="text" id="wifeName" oninput="calculateFamilyCounts()" placeholder="اسم الزوجة" class="bg-white border-none rounded-2xl p-5 text-sm font-bold shadow-sm">
                        <input type="text" id="wifeId" maxlength="9" oninput="only9Numbers(this)" placeholder="هوية الزوجة" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                        <input type="date" id="wifeDob" class="bg-white border-none rounded-2xl p-5 text-sm shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <input type="text" id="pDelegate" placeholder="المندوب (موسى، نبيل..)" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="text" id="pAltPhone" maxlength="9" oninput="only9Numbers(this)" placeholder="جوال بديل" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-mono">
                    <input type="text" id="originArea" placeholder="السكن الأصلي" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="text" id="displaceArea" placeholder="منطقة النزوح" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="totalCount" placeholder="إجمالي الأفراد" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="maleCount" placeholder="عدد الذكور" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                    <input type="number" id="femaleCount" placeholder="عدد الإناث" class="bg-slate-50 border-none rounded-2xl p-5 text-sm font-bold">
                </div>

                <div class="pt-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-slate-800 font-bold text-xl">أفراد العائلة</h3>
                        <button type="button" onclick="addMemberRow()" class="px-6 py-3 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-black transition-all">+ إضافة فرد</button>
                    </div>
                    <div id="membersList" class="space-y-4"></div>
                </div>

                <div class="pt-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-red-600 font-bold text-xl">الحالات الصحية</h3>
                        <button type="button" onclick="addHealthRow()" class="px-6 py-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold hover:bg-red-100 transition-all">+ إضافة حالة</button>
                    </div>
                    <div id="healthList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div class="bg-emerald-50 p-8 rounded-[2.5rem] border border-emerald-100">
                    <h3 class="text-emerald-900 font-bold mb-6">المحفظة الإلكترونية</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <input type="text" id="walletOwner" placeholder="اسم مالك المحفظة" class="bg-white border-none rounded-2xl p-5 text-sm font-bold shadow-sm">
                        <input type="text" id="walletId" maxlength="9" oninput="only9Numbers(this)" placeholder="هوية المالك" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                        <input type="text" id="walletPhone" maxlength="9" oninput="only9Numbers(this)" placeholder="جوال المحفظة" class="bg-white border-none rounded-2xl p-5 text-sm font-mono shadow-sm">
                    </div>
                </div>

                <div class="pt-10 flex gap-4">
                    <button type="submit" class="flex-[2] bg-indigo-600 text-white py-6 rounded-3xl font-black text-xl shadow-2xl shadow-indigo-200 hover:scale-[1.02] active:scale-95 transition-all">حفظ البيانات سحابياً</button>
                    <button type="button" onclick="closeModal('formModal')" class="flex-1 bg-slate-100 text-slate-500 py-6 rounded-3xl font-bold hover:bg-slate-200 transition-all">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1300] overflow-y-auto p-4 md:p-12 backdrop-blur-md">
        <div class="bg-white w-full max-w-4xl rounded-[3.5rem] shadow-2xl mx-auto modal-anim overflow-hidden">
            <div id="detailsContent" class="p-10 md:p-16">
                </div>
            <div class="p-10 bg-slate-50 flex justify-between items-center border-t border-slate-100">
                <button onclick="closeModal('detailsModal')" class="px-10 py-4 bg-white border border-slate-200 rounded-2xl font-bold text-slate-500 hover:bg-slate-100 transition-all">إغلاق</button>
                <div class="flex gap-2" id="detailActions">
                    </div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-[1400] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-[3rem] p-10 w-full max-w-xl shadow-2xl modal-anim">
            <h3 class="text-2xl font-black text-slate-800 mb-6">تخصيص التصدير</h3>
            <p class="text-slate-400 mb-6">اختر الأعمدة التي ترغب في تضمينها في ملف الإكسل</p>
            <div id="exportFieldCheckboxes" class="grid grid-cols-2 gap-3 mb-8 max-h-[40vh] overflow-y-auto p-2 bg-slate-50 rounded-2xl custom-scroll">
                </div>
            <div class="flex gap-4">
                <button onclick="openCustomExportMetaModal()" class="flex-1 bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-xl shadow-indigo-100">تصدير للملف</button>
                <button onclick="closeModal('exportModal')" class="flex-1 bg-slate-100 text-slate-500 py-5 rounded-2xl font-bold">تراجع</button>
            </div>
        </div>
    </div>

    <div id="customExportMetaModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1600] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl modal-anim overflow-hidden">
            <div class="p-8 border-b border-slate-100 bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">تأكيد التصدير المخصص</h3>
                <p class="text-slate-400 text-xs mt-1">أدخل بيانات الأرشفة للملف</p>
            </div>
            <div class="p-8 space-y-4">
                <div><label class="block text-xs font-bold text-slate-400 mb-2">اسم الملف</label><input type="text" id="ceFileName" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm" placeholder="مثال: تقرير شامل"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">النوع</label><input type="text" id="ceType" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">الجهة المانحة</label><input type="text" id="ceDonor" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الاستفادة</label><input type="date" id="ceDate" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                
                <div class="bg-indigo-50 p-4 rounded-xl flex justify-between items-center text-xs font-bold text-indigo-800">
                    <span>عدد المستفيدين: <span id="ceCountDisplay">0</span></span>
                    <span>تاريخ الأرشفة: <span id="ceArchiveDate"></span></span>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="executeCustomExport()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        تصدير
                    </button>
                    <button onclick="closeModal('customExportMetaModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1650] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl modal-anim overflow-hidden">
            <div class="p-8 border-b border-slate-100 bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">استيراد وأرشفة</h3>
                <p class="text-slate-400 text-xs mt-1">أدخل بيانات الملف للأرشفة قبل الاستيراد</p>
            </div>
            <div class="p-8 space-y-4">
                <div><label class="block text-xs font-bold text-slate-400 mb-2">اسم الملف</label><input type="text" id="impFileName" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm" placeholder="مثال: كشف وارد"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">النوع</label><input type="text" id="impType" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">الجهة المانحة</label><input type="text" id="impDonor" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الاستفادة</label><input type="date" id="impDate" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="triggerImportFile()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        اختيار الملف والاستيراد
                    </button>
                    <button onclick="closeModal('importModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">إلغاء</button>
                </div>
                <input type="file" id="realImportInput" hidden onchange="executeImport(event)">
            </div>
        </div>
    </div>

    <div id="mainExportModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1550] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl modal-anim overflow-hidden">
            <div class="p-8 border-b border-slate-100 bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">تصدير الفرز والأرشفة</h3>
                <p class="text-slate-400 text-xs mt-1">أدخل بيانات الملف للأرشفة قبل التصدير</p>
            </div>
            <div class="p-8 space-y-4">
                <div><label class="block text-xs font-bold text-slate-400 mb-2">اسم الملف</label><input type="text" id="meFileName" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm" placeholder="مثال: كشف الأيتام"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">النوع</label><input type="text" id="meType" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">الجهة المانحة</label><input type="text" id="meDonor" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الاستفادة</label><input type="date" id="meDate" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                
                <div class="bg-indigo-50 p-4 rounded-xl flex justify-between items-center text-xs font-bold text-indigo-800">
                    <span>عدد المستفيدين: <span id="meCountDisplay">0</span></span>
                    <span>تاريخ الأرشفة: <span id="meArchiveDate"></span></span>
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="executeMainExport()" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        تصدير وأرشفة
                    </button>
                    <button onclick="closeModal('mainExportModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="matchMetadataModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1700] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl modal-anim overflow-hidden">
            <div class="p-8 border-b border-slate-100 bg-slate-50">
                <h3 class="text-xl font-black text-slate-800">أرشفة ملف المطابقة</h3>
                <p class="text-slate-400 text-xs mt-1">تمت مطابقة <span id="matchCountDisplay" class="text-indigo-600 font-bold">0</span> مستفيد. يرجى إدخال بيانات السجل.</p>
            </div>
            <div class="p-8 space-y-4">
                <div><label class="block text-xs font-bold text-slate-400 mb-2">اسم الملف</label><input type="text" id="mmFileName" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">النوع</label><input type="text" id="mmType" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-2">الجهة المانحة</label><input type="text" id="mmDonor" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الاستفادة</label><input type="date" id="mmDate" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-sm"></div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="executeMatchArchive()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-indigo-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        حفظ في سجل المستفيدين
                    </button>
                    <button onclick="closeModal('matchMetadataModal')" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <div id="beneficiariesModal" class="fixed inset-0 bg-slate-900/80 hidden z-[1500] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-6xl rounded-[3rem] shadow-2xl modal-anim overflow-hidden h-[90vh] flex flex-col">
            <div class="p-4 md:p-8 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50">
                <h2 class="text-lg md:text-2xl font-black text-slate-800 flex items-center gap-3 w-full md:w-auto">
                    <div class="w-10 h-10 bg-emerald-600 text-white rounded-xl flex items-center justify-center"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg></div>
                    نظام المستفيدين والأرشفة
                </h2>
                <div class="flex flex-wrap items-center gap-2 md:gap-3 w-full md:w-auto justify-end">
                    <div class="bg-slate-200 p-1 rounded-xl flex text-[10px] md:text-xs font-bold overflow-x-auto max-w-full">
                        <button onclick="switchBenTab('new')" id="benTabNew" class="px-4 py-2 bg-white text-slate-800 rounded-lg shadow-sm transition-all">تصدير جديد</button>
                        <button onclick="switchBenTab('beneficiaries')" id="benTabBen" class="px-4 py-2 text-slate-500 hover:text-slate-700 transition-all">سجل المستفيدين</button>
                        <button onclick="switchBenTab('history')" id="benTabHistory" class="px-4 py-2 text-slate-500 hover:text-slate-700 transition-all">سجل الأرشيف</button>
                    </div>
                    <button onclick="closeModal('beneficiariesModal')" class="p-3 bg-white border rounded-xl hover:bg-red-50 hover:border-red-200 hover:text-red-500 transition-all">✕</button>
                </div>
            </div>
            
            <div id="benNewView" class="flex-1 overflow-y-auto md:overflow-hidden flex flex-col md:flex-row">
                <div class="flex-1 p-4 md:p-6 md:overflow-y-auto custom-scroll">
                    <div class="mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h3 class="font-bold text-slate-700">قائمة العائلات</h3>
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <button onclick="triggerMatchImport()" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-2 rounded-lg font-bold flex items-center gap-1 hover:bg-emerald-100 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                استرداد ملف (مطابقة)
                            </button>
                            <input type="file" id="matchImportInput" hidden onchange="processMatchImport(event)">
                            <input type="text" id="benSearch" oninput="renderBeneficiariesTable()" placeholder="بحث سريع..." class="bg-slate-50 border-none rounded-xl px-4 py-2 text-sm font-bold">
                            <button onclick="selectAllBen(true)" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg font-bold">تحديد الكل</button>
                            <button onclick="selectAllBen(false)" class="text-xs bg-slate-100 text-slate-500 px-3 py-2 rounded-lg font-bold">إلغاء</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right min-w-[600px]">
                            <thead class="text-xs text-slate-400 font-bold uppercase border-b bg-slate-50 sticky top-0">
                                <tr><th class="p-3">اختيار</th><th class="p-3">الاسم</th><th class="p-3">الهوية</th><th class="p-3">الجوال</th><th class="p-3">العدد</th><th class="p-3">المندوب</th></tr>
                            </thead>
                            <tbody id="benTableBody" class="text-sm font-bold text-slate-700 divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>

                <div class="w-full md:w-96 bg-slate-50 border-b md:border-b-0 md:border-r p-4 md:p-6 md:overflow-y-auto custom-scroll shadow-inner shrink-0 order-first md:order-none">
                    <div id="exportPanel" class="opacity-50 pointer-events-none transition-all">
                        <h3 class="font-black text-slate-800 mb-6 text-lg">بيانات التصدير والأرشفة</h3>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-400 mb-2">اسم الملف</label><input type="text" id="expFileName" class="w-full bg-white border-none rounded-xl p-3 font-bold text-sm shadow-sm" placeholder="مثال: توزيعة سلة غذائية"></div>
                            <div><label class="block text-xs font-bold text-slate-400 mb-2">نوع الملف / المساعدة</label><input type="text" id="expFileType" class="w-full bg-white border-none rounded-xl p-3 font-bold text-sm shadow-sm" placeholder="مثال: طرود صحية"></div>
                            <div><label class="block text-xs font-bold text-slate-400 mb-2">الجهة المانحة</label><input type="text" id="expDonor" class="w-full bg-white border-none rounded-xl p-3 font-bold text-sm shadow-sm"></div>
                            <div><label class="block text-xs font-bold text-slate-400 mb-2">تاريخ الاستفادة</label><input type="date" id="expDate" class="w-full bg-white border-none rounded-xl p-3 font-bold text-sm shadow-sm"></div>
                            <div><label class="block text-xs font-bold text-slate-400 mb-2">ملاحظات إضافية</label><textarea id="expNotes" rows="3" class="w-full bg-white border-none rounded-xl p-3 font-bold text-sm shadow-sm"></textarea></div>
                            
                            <div class="pt-4 border-t border-slate-200 mt-4">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-xs font-bold text-slate-500">العائلات المحددة:</span>
                                    <span id="selectedCountBadge" class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">0</span>
                                </div>
                                <button onclick="executeBenExport()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                    تصدير وأرشفة (Excel)
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="selectHint" class="text-center text-slate-400 mt-10 text-sm font-bold">
                        يرجى تحديد عائلة واحدة على الأقل لتفعيل التصدير
                    </div>
                </div>
            </div>

            <div id="benBeneficiariesView" class="hidden flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
                <div class="overflow-x-auto">
                    <table class="w-full text-right min-w-[900px]">
                        <thead class="text-xs text-slate-400 font-bold uppercase border-b bg-slate-50 sticky top-0">
                            <tr>
                                <th class="p-4">اسم الملف</th>
                                <th class="p-4">حالة الملف</th>
                                <th class="p-4">النوع</th>
                                <th class="p-4">الجهة المانحة</th>
                                <th class="p-4">تاريخ الاستفادة</th>
                                <th class="p-4">عدد المستفيدين</th>
                                <th class="p-4">تاريخ الأرشفة</th>
                                <th class="p-4">بواسطة</th>
                                <th class="p-4">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="benBeneficiariesBody" class="text-sm font-bold text-slate-700 divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>

            <div id="benHistoryView" class="hidden flex-1 overflow-y-auto custom-scroll p-4 md:p-8">
                <div class="overflow-x-auto">
                    <table class="w-full text-right min-w-[900px]">
                        <thead class="text-xs text-slate-400 font-bold uppercase border-b bg-slate-50 sticky top-0">
                            <tr>
                                <th class="p-4">اسم الملف</th>
                                <th class="p-4">حالة الملف</th>
                                <th class="p-4">النوع</th>
                                <th class="p-4">الجهة المانحة</th>
                                <th class="p-4">تاريخ الاستفادة</th>
                                <th class="p-4">عدد المستفيدين</th>
                                <th class="p-4">تاريخ الأرشفة</th>
                                <th class="p-4">بواسطة</th>
                                <th class="p-4">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="benHistoryBody" class="text-sm font-bold text-slate-700 divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="undoToast" class="fixed bottom-10 left-10 right-10 md:left-1/2 md:-translate-x-1/2 md:w-fit bg-slate-900 text-white px-8 py-6 rounded-[2rem] shadow-2xl flex items-center justify-between gap-12 z-[2000] hidden transform transition-all duration-500">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-red-500/20 text-red-400 rounded-2xl flex items-center justify-center animate-pulse">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </div>
            <div>
                <p class="font-bold">تم حذف البيانات سحابياً</p>
                <p class="text-slate-400 text-xs mt-1">لديك 5 ثوانٍ لاستعادة البيانات</p>
            </div>
        </div>
        <button onclick="cancelDelete()" class="bg-white text-slate-900 px-8 py-3 rounded-xl font-bold hover:bg-indigo-50 transition-all">تراجع الآن</button>
    </div>

    <script>
        window.families = [];
        let deleteTimer = null;
        let pendingDeleteId = null;
        let showDupsOnly = false;
        let currentViewData = []; 
        let currentViewMode = 'family'; 
        let matchedIdsForArchive = []; // To store IDs from match import

        const FIELD_MAP = {
            pName: "اسم رب الأسرة",
            pId: "هوية رب الأسرة",
            pIdIssue: "اصدار الهوية",
            pDob: "تاريخ ميلاد رب الأسرة",
            pPhone: "رقم الجوال",
            wifeName: "اسم الزوجة",
            wifeId: "هوية الزوجة",
            wifeDob: "تاريخ ميلاد الزوجة",
            pSocial: "الحالة الاجتماعية",
            pDelegate: "اسم المندوب",
            pAltPhone: "جوال بديل",
            originArea: "منطقة السكن الأصلية",
            displaceArea: "منطقة النزوح الحالية",
            totalCount: "عدد الأفراد الكلي",
            femaleCount: "عدد الإناث",
            maleCount: "عدد الذكور",
            walletOwner: "مالك المحفظة",
            walletId: "هوية المحفظة",
            walletPhone: "جوال المحفظة"
        };

        function only9Numbers(input) { input.value = input.value.replace(/\D/g, '').substring(0, 9); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function getAge(dob) {
            if (!dob) return { y: 0, m: 0 };
            const birth = new Date(dob);
            const now = new Date();
            let y = now.getFullYear() - birth.getFullYear();
            let m = now.getMonth() - birth.getMonth();
            if (m < 0) { y--; m += 12; }
            return { y, m };
        }

        // ===========================================
        //       Multi-select Dropdown Logic
        // ===========================================
        
        window.toggleMultiSelect = function(id) {
            const optionsDiv = document.getElementById(id + '-options');
            const allOptions = document.querySelectorAll('.multiselect-options');
            allOptions.forEach(div => {
                if(div.id !== id + '-options') div.classList.remove('show');
            });
            optionsDiv.classList.toggle('show');
        };

        window.onclick = function(event) {
            if (!event.target.closest('.multiselect-container')) {
                document.querySelectorAll('.multiselect-options').forEach(div => div.classList.remove('show'));
            }
        };

        function getCheckedValues(containerId) {
            const container = document.getElementById(containerId + '-container');
            if(!container) return [];
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // ===========================================
        //       User Management Logic
        // ===========================================

        function openUserManagement() {
            if(window.currentUserData.role !== 'super_admin') {
                alert("غير مصرح لك");
                return;
            }
            document.getElementById('userParamsModal').classList.remove('hidden');
            switchUserTab('create');
        }

        function switchUserTab(tabName) {
            document.querySelectorAll('.user-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tabBtn-"]').forEach(el => el.className = "w-full text-right p-4 rounded-xl font-bold text-slate-500 hover:bg-white hover:shadow-sm transition-all");
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`tabBtn-${tabName}`).className = "w-full text-right p-4 rounded-xl font-bold text-slate-800 bg-white shadow-md transition-all";

            if(tabName === 'list' || tabName === 'trash') {
                fetchUsersList(tabName === 'trash');
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const name = document.getElementById('newUserName').value;
            const user = document.getElementById('newUserUser').value;
            const pass = document.getElementById('newUserPass').value;
            const role = document.getElementById('newUserRole').value;
            
            const perms = Array.from(document.querySelectorAll('input[name="perms"]:checked')).map(cb => cb.value);
            if(!perms.includes('view')) perms.push('view');

            try {
                const q = window.fs.query(window.fs.collection(window.db, "app_users"), window.fs.where("username", "==", user));
                const snap = await window.fs.getDocs(q);
                if(!snap.empty) {
                    alert("اسم المستخدم هذا موجود مسبقاً");
                    return;
                }

                await window.fs.addDoc(window.fs.collection(window.db, "app_users"), {
                    name, username: user, password: pass, role, permissions: perms,
                    createdAt: new Date().toISOString(),
                    isDisabled: false,
                    isOnline: false,
                    lastLogin: null
                });
                alert("تم إنشاء المستخدم بنجاح");
                document.getElementById('createUserForm').reset();
            } catch(err) {
                console.error(err);
                alert("خطأ أثناء الإنشاء");
            }
        }

        async function fetchUsersList(showDisabled) {
            const tbody = showDisabled ? document.getElementById('trashUsersBody') : document.getElementById('usersListBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">جاري التحميل...</td></tr>';

            try {
                const q = window.fs.query(window.fs.collection(window.db, "app_users"), window.fs.orderBy("createdAt", "desc"));
                const snap = await window.fs.getDocs(q);
                
                tbody.innerHTML = '';
                
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.isDisabled !== showDisabled) return; 

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50 hover:bg-slate-50 transition-all";
                    
                    if(!showDisabled) {
                        const isOnline = data.isOnline ? '<span class="text-emerald-500">نشط الآن</span>' : '<span class="text-slate-400">غير متاح</span>';
                        const lastLogin = data.lastLogin ? new Date(data.lastLogin).toLocaleString('ar-EG') : 'لم يدخل بعد';
                        const permsString = (data.permissions || []).join(',');
                        
                        tr.innerHTML = `
                            <td class="p-4">${data.name}</td>
                            <td class="p-4 font-mono">${data.username}</td>
                            <td class="p-4"><span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded text-xs">${data.role}</span></td>
                            <td class="p-4 text-xs font-mono">${lastLogin}</td>
                            <td class="p-4 text-xs font-bold">${isOnline}</td>
                            <td class="p-4 flex justify-center">
                                <button onclick="toggleUserStatus('${doc.id}', true)" class="text-red-400 hover:text-red-600 font-bold text-xs border border-red-200 px-3 py-1 rounded-lg">تعطيل</button>
                            </td>
                            <td class="p-4 flex justify-center">
                                <button onclick="openEditCreds('${doc.id}', '${data.username}', '${data.password}', '${permsString}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 px-3 py-1 rounded-lg text-xs font-bold">تعديل</button>
                            </td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td class="p-4 opacity-50">${data.name}</td>
                            <td class="p-4 font-mono opacity-50">${data.username}</td>
                            <td class="p-4 opacity-50">${data.role}</td>
                            <td class="p-4 flex justify-center gap-2">
                                <button onclick="toggleUserStatus('${doc.id}', false)" class="bg-emerald-50 text-emerald-600 font-bold text-xs px-3 py-1 rounded-lg">استعادة</button>
                                <button onclick="deleteUserPermanently('${doc.id}')" class="bg-red-600 text-white font-bold text-xs px-3 py-1 rounded-lg">حذف نهائي</button>
                            </td>
                        `;
                    }
                    tbody.appendChild(tr);
                });
                
                if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-slate-400">لا يوجد بيانات</td></tr>';

            } catch(err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-400">خطأ في التحميل</td></tr>';
            }
        }

        window.toggleUserStatus = async function(id, disable) {
            if(!confirm(disable ? "هل أنت متأكد من تعطيل الحساب؟" : "استعادة الحساب؟")) return;
            try {
                await window.fs.updateDoc(window.fs.doc(window.db, "app_users", id), { isDisabled: disable });
                fetchUsersList(disable ? false : true); 
            } catch(err) { alert(err.message); }
        };

        window.deleteUserPermanently = async function(id) {
            if(!confirm("حذف نهائي؟ لا يمكن التراجع!")) return;
            try {
                await window.fs.deleteDoc(window.fs.doc(window.db, "app_users", id));
                fetchUsersList(true);
            } catch(err) { alert(err.message); }
        };

        // ===========================================
        //       Credentials Editing Logic
        // ===========================================

        window.openEditCreds = function(id, user, pass, permsString) {
            document.getElementById('editCredsId').value = id;
            document.getElementById('editCredsUser').value = user;
            document.getElementById('editCredsPass').value = ""; // Don't show old pass for security in UI usually, but user asked for it in prev versions. Let's keep it blank for "Change" logic or leave it as placeholder. Code above had `value = pass`.
            document.getElementById('editCredsPass').placeholder = "أدخل كلمة جديدة للتغيير";
            
            // If editing own profile as non-admin, disable username and permissions
            if(window.currentUserData.role !== 'super_admin') {
                document.getElementById('editCredsUser').disabled = true;
                document.getElementById('usernameEditField').classList.add('opacity-50');
                document.getElementById('editPermsContainer').classList.add('hidden');
            } else {
                document.getElementById('editCredsUser').disabled = false;
                document.getElementById('usernameEditField').classList.remove('opacity-50');
                document.getElementById('editPermsContainer').classList.remove('hidden');
                
                // Populate permissions
                const perms = permsString ? permsString.split(',') : [];
                document.querySelectorAll('input[name="editPerms"]').forEach(cb => {
                    cb.checked = perms.includes(cb.value);
                });
            }
            
            document.getElementById('editCredsModal').classList.remove('hidden');
        };

        window.openMyProfile = function() {
            if(!window.currentUserData || window.currentUserData.type === 'google_auth') {
                alert("لا يمكن تغيير كلمة المرور للحساب الرئيسي من هنا");
                return;
            }
            const id = window.currentUserData.id;
            const user = window.currentUserData.username;
            openEditCreds(id, user, '', '');
        };

        window.handleSaveCreds = async function(e) {
            e.preventDefault();
            const id = document.getElementById('editCredsId').value;
            const newUser = document.getElementById('editCredsUser').value;
            const newPass = document.getElementById('editCredsPass').value;
            
            let updatePayload = { username: newUser };
            if(newPass && newPass.trim() !== "") {
                updatePayload.password = newPass;
            }

            // Only update permissions if super_admin
            if(window.currentUserData.role === 'super_admin') {
                const newPerms = Array.from(document.querySelectorAll('input[name="editPerms"]:checked')).map(cb => cb.value);
                if(!newPerms.includes('view')) newPerms.push('view');
                updatePayload.permissions = newPerms;
            }

            try {
                await window.fs.updateDoc(window.fs.doc(window.db, "app_users", id), updatePayload);
                alert("تم تحديث البيانات بنجاح");
                closeModal('editCredsModal');
                
                // Refresh list if open
                if(!document.getElementById('userParamsModal').classList.contains('hidden')) {
                    fetchUsersList(false);
                }

            } catch(err) {
                console.error(err);
                alert("خطأ أثناء التحديث");
            }
        };


        // ===========================================
        //       Existing Data Logic 
        // ===========================================
        
        function hasPerm(p) {
            if (!window.currentUserData) return false;
            if (window.currentUserData.role === 'beneficiary' && p === 'edit') return true; // السماح للمستفيد بالتعديل
            return window.currentUserData.permissions.includes(p) || window.currentUserData.permissions.includes('all');
        }

        function updateDelegateFilterOptions() {
            const container = document.getElementById('filterDelegate-options');
            if (!container) return;
            
            const currentChecked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const delegates = [...new Set(window.families.map(f => f.pDelegate ? f.pDelegate.trim() : "").filter(d => d !== ""))].sort();
            
            let html = '';
            delegates.forEach(d => {
                const isChecked = currentChecked.includes(d) ? 'checked' : '';
                html += `<label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="${d}" ${isChecked}> ${d}</label>`;
            });
            
            if(delegates.length === 0) html = '<div class="p-2 text-xs text-slate-400 text-center">لا يوجد مناديب</div>';
            container.innerHTML = html;
        }

        function updateSocialFilterOptions() {
            const container = document.getElementById('filterSocial-options');
            if (!container) return;
            
            const currentChecked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const socials = [...new Set(window.families.map(f => f.pSocial ? f.pSocial.trim() : "").filter(s => s !== ""))].sort();
            
            let html = '';
            socials.forEach(s => {
                const isChecked = currentChecked.includes(s) ? 'checked' : '';
                html += `<label class="multiselect-option"><input type="checkbox" onchange="runFilters()" value="${s}" ${isChecked}> ${s}</label>`;
            });
            
            if(socials.length === 0) html = '<div class="p-2 text-xs text-slate-400 text-center">لا يوجد بيانات</div>';
            container.innerHTML = html;
        }

        function runFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            // Collect multi-select values
            const ageFilters = getCheckedValues('filterAge');
            const diseaseFilters = getCheckedValues('filterDisease');
            const delegateFilters = getCheckedValues('filterDelegate');
            const socialFilters = getCheckedValues('filterSocial');
            const countFilters = getCheckedValues('filterCount');

            // Update Labels (Optional UX improvement)
            document.getElementById('filterAge-label').innerText = ageFilters.length > 0 ? `تم اختيار ${ageFilters.length}` : 'اختيار الفئات العمرية...';
            document.getElementById('filterDisease-label').innerText = diseaseFilters.length > 0 ? `تم اختيار ${diseaseFilters.length}` : 'اختيار الحالات...';
            document.getElementById('filterDelegate-label').innerText = delegateFilters.length > 0 ? `تم اختيار ${delegateFilters.length}` : 'كل المناديب';
            document.getElementById('filterSocial-label').innerText = socialFilters.length > 0 ? `تم اختيار ${socialFilters.length}` : 'كل الحالات';
            document.getElementById('filterCount-label').innerText = countFilters.length > 0 ? `تم اختيار ${countFilters.length}` : 'اختيار العدد...';


            let resultData = [];
            currentViewMode = 'family';

            const matchesSearch = (f) => (f.pName || "").toLowerCase().includes(search) || 
                                         (f.pId || "").includes(search) || 
                                         (f.pDelegate || "").toLowerCase().includes(search) ||
                                         (f.totalCount || "").toString().includes(search);
            
            const isRestricted = window.currentUserData?.role === 'viewer' && !hasPerm('view_all');

            // Logic adapted for multiple selections
            if (ageFilters.length > 0 && !ageFilters.includes('all')) {
                    currentViewMode = 'individual';
                    window.families.forEach(f => {
                        if (!matchesSearch(f)) return;
                        (f.members || []).forEach(m => {
                            if (!m.dob || m.dob.trim() === '') return;
                            const age = getAge(m.dob);
                            let match = false;
                            
                            ageFilters.forEach(ageF => {
                                if (ageF === '0-1' && age.y === 0) match = true;
                                if (ageF === '1-2' && age.y === 1) match = true;
                                if (ageF === '2-5' && age.y >= 2 && age.y <= 5) match = true;
                                if (ageF === '5-10' && age.y > 5 && age.y <= 10) match = true;
                                if (ageF === '10-17' && age.y > 10 && age.y <= 17) match = true;
                                if (ageF === '18-25' && age.y > 17 && age.y <= 25) match = true;
                                if (ageF === '26-40' && age.y > 25 && age.y <= 40) match = true;
                                if (ageF === '41-100' && age.y > 40 && age.y <= 100) match = true;
                            });

                            if (match) {
                                resultData.push({
                                    type: 'individual',
                                    familyId: f.id,
                                    targetName: m.name,
                                    targetId: m.idNum,
                                    targetAge: `${age.y} سنة`,
                                    relation: m.relation,
                                    pName: f.pName,
                                    pId: f.pId,
                                    wifeName: f.wifeName,
                                    wifeId: f.wifeId,
                                    pPhone: f.pPhone
                                });
                            }
                        });
                        [ {name: f.pName, dob: f.pDob, id: f.pId, role: 'أب'}, {name: f.wifeName, dob: f.wifeDob, id: f.wifeId, role: 'زوجة'} ]
                        .filter(p => p.name && p.dob && p.dob.trim() !== '')
                        .forEach(p => {
                            const age = getAge(p.dob);
                            let match = false;
                            
                            ageFilters.forEach(ageF => {
                                if (ageF === '0-1' && age.y === 0) match = true;
                                if (ageF === '1-2' && age.y === 1) match = true;
                                if (ageF === '2-5' && age.y >= 2 && age.y <= 5) match = true;
                                if (ageF === '5-10' && age.y > 5 && age.y <= 10) match = true;
                                if (ageF === '10-17' && age.y > 10 && age.y <= 17) match = true;
                                if (ageF === '18-25' && age.y > 17 && age.y <= 25) match = true;
                                if (ageF === '26-40' && age.y > 25 && age.y <= 40) match = true;
                                if (ageF === '41-80' && age.y > 40 && age.y <= 80) match = true;
                            });

                            if (match) {
                                resultData.push({
                                    type: 'individual',
                                    familyId: f.id,
                                    targetName: p.name,
                                    targetId: p.id,
                                    targetAge: `${age.y} سنة`,
                                    relation: p.role,
                                    pName: f.pName,
                                    pId: f.pId,
                                    wifeName: f.wifeName,
                                    wifeId: f.wifeId,
                                    pPhone: f.pPhone
                                });
                            }
                        });
                    });
            } else if (diseaseFilters.length > 0 && !diseaseFilters.includes('all')) {
                currentViewMode = 'health';
                window.families.forEach(f => {
                    if (!matchesSearch(f)) return;
                    (f.health || []).forEach(h => {
                        if (diseaseFilters.includes(h.type)) {
                            resultData.push({
                                type: 'health',
                                familyId: f.id,
                                patientName: h.name,
                                patientId: h.idNum,
                                patientDob: h.dob,
                                diseaseType: h.type,
                                diseaseDesc: h.desc,
                                pName: f.pName,
                                pId: f.pId,
                                wifeName: f.wifeName,
                                wifeId: f.wifeId,
                                pPhone: f.pPhone
                            });
                        }
                    });
                });
            } else {
                currentViewMode = 'family';
                let filtered = window.families.filter(f => {
                    const mSearch = matchesSearch(f);
                    const mDelegate = delegateFilters.length === 0 || delegateFilters.includes('all') || delegateFilters.includes((f.pDelegate || "").trim());
                    const mSocial = socialFilters.length === 0 || socialFilters.includes('all') || socialFilters.includes((f.pSocial || "").trim());
                    
                    let calculatedCount = 1;
                    if(f.wifeName && f.wifeName.trim()) calculatedCount++;
                    if(f.members && Array.isArray(f.members)) calculatedCount += f.members.length;

                    const mCount = countFilters.length === 0 || countFilters.includes('all') || countFilters.includes(calculatedCount.toString());
                    return mSearch && mDelegate && mSocial && mCount;
                });
                if (showDupsOnly) {
                    const idCounts = {};
                    window.families.forEach(f => idCounts[f.pId] = (idCounts[f.pId] || 0) + 1);
                    filtered = filtered.filter(f => idCounts[f.pId] > 1);
                }
                resultData = filtered.map(f => {
                    let count = 1; // رب الأسرة
                    if(f.wifeName && f.wifeName.trim()) count++; // الزوجة
                    if(f.members && Array.isArray(f.members)) count += f.members.length; // الأفراد

                    return {
                        type: 'family',
                        familyId: f.id,
                        pName: f.pName,
                        pId: f.pId,
                        wifeName: f.wifeName,
                        wifeId: f.wifeId,
                        pPhone: f.pPhone,
                        pDelegate: f.pDelegate,
                        pSocial: f.pSocial,
                        totalCount: count,
                        raw: f 
                    };
                });
            }

            currentViewData = resultData;
            renderTable(resultData, isRestricted);
            updateStats(window.families);
        }
        window.runFilters = runFilters;

        function updateStats(data) {
            document.getElementById('totalFamilies').innerText = data.length;
            let total = 0;
            data.forEach(f => {
                total++; // رب الأسرة
                if (f.wifeName && f.wifeName.trim()) total++; // الزوجة
                if (f.members && Array.isArray(f.members)) total += f.members.length; // الأفراد المضافين
            });
            document.getElementById('totalPersons').innerText = total;

            const idCounts = {};
            let dups = 0;
            data.forEach(f => {
                idCounts[f.pId] = (idCounts[f.pId] || 0) + 1;
                if(idCounts[f.pId] === 2) dups++;
            });
            document.getElementById('totalDuplicates').innerText = dups;
        }

        window.toggleMainSelectAll = function(source) {
            const checkboxes = document.querySelectorAll('.main-row-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateMainSelection();
        };

        window.updateMainSelection = function() {
            const count = document.querySelectorAll('.main-row-check:checked').length;
            document.getElementById('selectedMainCount').innerText = count;
            const bar = document.getElementById('bulkActionsBar');
            if(count > 0) bar.classList.remove('hidden');
            else bar.classList.add('hidden');
        };

        window.deleteSelectedRows = async function() {
            if(!hasPerm('remove')) return alert("ليس لديك صلاحية الحذف");
            const checks = document.querySelectorAll('.main-row-check:checked');
            if(checks.length === 0) return;
            
            if(!confirm(`هل أنت متأكد من حذف ${checks.length} سجلات؟ (سيتم حذف العائلة بالكامل)`)) return;

            const idsToDelete = new Set();
            checks.forEach(cb => idsToDelete.add(cb.value)); // value is familyId

            let deletedCount = 0;
            try {
                for(let id of idsToDelete) {
                    await window.fs.deleteDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "families", id));
                    deletedCount++;
                }
                alert(`تم حذف ${deletedCount} سجل بنجاح`);
                document.getElementById('bulkActionsBar').classList.add('hidden');
            } catch(e) {
                alert("حدث خطأ أثناء الحذف: " + e.message);
            }
        };

        function renderTable(data, isRestricted = false) {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (isRestricted) {
                thead.innerHTML = `<tr class="bg-slate-50/50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b">
                    <th class="px-4 py-4">الاسم</th>
                    <th class="px-4 py-4">المندوب</th>
                    <th class="px-4 py-4 text-center">إجراءات</th>
                </tr>`;

                data.forEach((row) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-all border-b border-slate-50";
                    
                    let actionButtons = `<button onclick="viewDetails('${row.familyId}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="تفاصيل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>`;
                    if(hasPerm('edit')) actionButtons += `<button onclick="editFamily('${row.familyId}')" class="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition-all" title="تعديل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>`;
                    if(hasPerm('remove')) actionButtons += `<button onclick="triggerDelete('${row.familyId}')" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-all" title="حذف"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
                    
                    const actions = `<div class="flex items-center justify-center gap-2">${actionButtons}</div>`;

                    let nameDisplay = row.pName;
                    if (currentViewMode === 'individual') nameDisplay = (row.targetName || '-') + " (تابع لـ " + row.pName + ")";
                    if (currentViewMode === 'health') nameDisplay = (row.patientName || '-') + " (تابع لـ " + row.pName + ")";

                    tr.innerHTML = `
                        <td class="px-4 py-4 font-bold text-slate-700">${nameDisplay}</td>
                        <td class="px-4 py-4"><span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">${row.pDelegate || '-'}</span></td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                    tbody.appendChild(tr);
                });
                return;
            }

            let headersHTML = '';
            if (currentViewMode === 'individual') {
                headersHTML = `
                    <th class="px-4 py-4 w-10"><input type="checkbox" onchange="toggleMainSelectAll(this)" class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"></th>
                    <th class="px-4 py-4">اسم الفرد</th>
                    <th class="px-4 py-4">هوية الفرد</th>
                    <th class="px-4 py-4">العمر/الصلة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">رقم الجوال</th>
                    <th class="px-4 py-4 text-center">إجراءات</th>
                `;
            } else if (currentViewMode === 'health') {
                headersHTML = `
                    <th class="px-4 py-4 w-10"><input type="checkbox" onchange="toggleMainSelectAll(this)" class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"></th>
                    <th class="px-4 py-4">اسم المريض</th>
                    <th class="px-4 py-4">هوية المريض</th>
                    <th class="px-4 py-4">تاريخ الميلاد</th>
                    <th class="px-4 py-4">نوع المرض</th>
                    <th class="px-4 py-4">تفاصيل المرض</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الأب</th>
                    <th class="px-4 py-4 bg-indigo-50/50">اسم الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">هوية الزوجة</th>
                    <th class="px-4 py-4 bg-indigo-50/50">رقم الجوال</th>
                    <th class="px-4 py-4 text-center">إجراءات</th>
                `;
            } else {
                headersHTML = `
                    <th class="px-4 py-4 w-10"><input type="checkbox" onchange="toggleMainSelectAll(this)" class="w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"></th>
                    <th class="px-4 py-4">اسم الأب</th>
                    <th class="px-4 py-4">هوية الأب</th>
                    <th class="px-4 py-4">اسم الزوجة</th>
                    <th class="px-4 py-4">هوية الزوجة</th>
                    <th class="px-4 py-4">الجوال</th>
                    <th class="px-4 py-4">المندوب</th>
                    <th class="px-4 py-4">الحالة الاجتماعية</th>
                    <th class="px-4 py-4">العدد</th>
                    <th class="px-4 py-4 text-center">الإجراءات</th>
                `;
            }
            thead.innerHTML = `<tr class="bg-slate-50/50 text-slate-500 text-xs font-bold uppercase tracking-wider border-b">${headersHTML}</tr>`;

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-all border-b border-slate-50";
                
                const checkboxHTML = `<td class="px-4 py-4"><input type="checkbox" value="${row.familyId}" data-index="${index}" onchange="updateMainSelection()" class="main-row-check w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer"></td>`;
                let rowHTML = '';
                
                let actionButtons = `
                    <button onclick="viewDetails('${row.familyId}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" title="تفاصيل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></button>
                `;

                if(hasPerm('edit')) {
                    actionButtons += `<button onclick="editFamily('${row.familyId}')" class="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition-all" title="تعديل"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>`;
                }
                if(hasPerm('remove')) {
                    actionButtons += `<button onclick="triggerDelete('${row.familyId}')" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition-all" title="حذف"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
                }

                const actions = `<div class="flex items-center justify-center gap-2">${actionButtons}</div>`;

                if (currentViewMode === 'individual') {
                     rowHTML = `
                        ${checkboxHTML}
                        <td class="px-4 py-4 font-bold text-indigo-700">${row.targetName || '-'}</td>
                        <td class="px-4 py-4 font-mono">${isRestricted ? '*****' : (row.targetId || '-')}</td>
                        <td class="px-4 py-4 text-xs font-bold text-slate-500">${row.targetAge} (${row.relation})</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.pName}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : row.pId}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : (row.wifeId || '-')}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : row.pPhone}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                } else if (currentViewMode === 'health') {
                     rowHTML = `
                        ${checkboxHTML}
                        <td class="px-4 py-4 font-bold text-red-600">${row.patientName || '-'}</td>
                        <td class="px-4 py-4 font-mono">${isRestricted ? '*****' : (row.patientId || '-')}</td>
                        <td class="px-4 py-4 font-mono">${row.patientDob || '-'}</td>
                        <td class="px-4 py-4 text-xs font-bold bg-red-50 text-red-600 rounded-lg">${row.diseaseType}</td>
                        <td class="px-4 py-4 text-xs max-w-[200px] truncate" title="${row.diseaseDesc || ''}">${row.diseaseDesc || '-'}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.pName}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : row.pId}</td>
                        <td class="px-4 py-4 bg-indigo-50/10">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : (row.wifeId || '-')}</td>
                        <td class="px-4 py-4 font-mono bg-indigo-50/10">${isRestricted ? '*****' : row.pPhone}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                } else {
                     rowHTML = `
                        ${checkboxHTML}
                        <td class="px-4 py-4 font-bold text-slate-700">${row.pName}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">${isRestricted ? '*****' : row.pId}</td>
                        <td class="px-4 py-4">${row.wifeName || '-'}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">${isRestricted ? '*****' : (row.wifeId || '-')}</td>
                        <td class="px-4 py-4 font-mono text-slate-500">${isRestricted ? '*****' : `0${row.pPhone}`}</td>
                        <td class="px-4 py-4"><span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">${row.pDelegate || '-'}</span></td>
                        <td class="px-4 py-4 text-xs font-bold">${row.pSocial || '-'}</td>
                        <td class="px-4 py-4 font-bold">${row.totalCount || 0}</td>
                        <td class="px-4 py-4">${actions}</td>
                    `;
                }

                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
        }

        function openForm() {
            // السماح للمستفيد بفتح النموذج للتعديل فقط
            if(window.currentUserData.role !== 'beneficiary' && !hasPerm('add')) {
                return alert("ليس لديك صلاحية إضافة بيانات");
            }
            document.getElementById('mainForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('membersList').innerHTML = '';
            document.getElementById('healthList').innerHTML = '';
            document.getElementById('modalTitle').innerText = 'إضافة بيانات عائلة';
            
            // إعادة تفعيل حقل المندوب للوضع الافتراضي (للمدراء)
            const delInput = document.getElementById('pDelegate');
            delInput.disabled = false;
            delInput.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
            delInput.classList.add('bg-slate-50');

            document.getElementById('formModal').classList.remove('hidden');
        }

        window.calculateFamilyCounts = function() {
            let calcTotal = 1; // رب الأسرة
            let calcMale = 0;
            let calcFemale = 0;

            const pSocial = document.getElementById('pSocial').value;
            if(['ارمله', 'مطلقة', 'مهجورة'].includes(pSocial)) calcFemale++;
            else calcMale++;

            const wifeName = document.getElementById('wifeName').value;
            if(wifeName && wifeName.trim()) {
                calcTotal++;
                calcFemale++;
            }

            const members = document.querySelectorAll('.member-row');
            members.forEach(row => {
                const relation = row.querySelector('.m-rel').value;
                calcTotal++;
                if(['اخ', 'ابن', 'اب', 'جد'].includes(relation)) calcMale++;
                else calcFemale++;
            });

            document.getElementById('totalCount').value = calcTotal;
            document.getElementById('maleCount').value = calcMale;
            document.getElementById('femaleCount').value = calcFemale;

            return { total: calcTotal, male: calcMale, female: calcFemale };
        };

        function addMemberRow(data = {}) {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-4 gap-3 bg-white p-6 rounded-3xl shadow-sm border border-slate-100 relative member-row";
            div.innerHTML = `
                <input type="text" placeholder="اسم الفرد" class="m-name border-none bg-slate-50 rounded-xl p-4 text-xs font-bold" value="${data.name || ''}">
                <select class="m-rel border-none bg-slate-50 rounded-xl p-4 text-xs font-bold" onchange="calculateFamilyCounts()">
                    ${['اخ', 'اخت', 'زوجة', 'ابن', 'ابنه', 'ام', 'اب', 'خاله', 'عمه', 'جد', 'جده', 'محتضنه'].map(r => `<option ${data.relation === r ? 'selected' : ''}>${r}</option>`).join('')}
                </select>
                <input type="date" class="m-dob border-none bg-slate-50 rounded-xl p-4 text-xs font-bold" value="${data.dob || ''}">
                <input type="text" maxlength="9" placeholder="رقم الهوية" class="m-id border-none bg-slate-50 rounded-xl p-4 text-xs font-mono font-bold" value="${data.idNum || ''}">
                <button type="button" onclick="this.parentElement.remove(); calculateFamilyCounts()" class="absolute -left-2 -top-2 bg-white text-red-500 w-8 h-8 rounded-full shadow-md border flex items-center justify-center font-black">×</button>
            `;
            document.getElementById('membersList').appendChild(div);
            calculateFamilyCounts();
        }

        function addHealthRow(data = {}) {
            const div = document.createElement('div');
            div.className = "bg-red-50/20 p-6 rounded-3xl border border-red-100 relative health-row space-y-3";
            div.innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <select class="h-type border-none bg-white rounded-xl p-4 text-xs font-bold">
                        ${['مرض مزمن', 'اعاقة سمعية', 'اعاقة حركية', 'اعاقة بصرية', 'اخرى'].map(t => `<option ${data.type === t ? 'selected' : ''}>${t}</option>`).join('')}
                    </select>
                    <input type="text" placeholder="الاسم" class="h-name border-none bg-white rounded-xl p-4 text-xs font-bold" value="${data.name || ''}">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="text" placeholder="الهوية" maxlength="9" class="h-id border-none bg-white rounded-xl p-4 text-xs font-mono" value="${data.idNum || ''}">
                    <input type="text" placeholder="الجوال" maxlength="9" class="h-phone border-none bg-white rounded-xl p-4 text-xs font-mono" value="${data.phone || ''}">
                    <input type="date" class="h-dob border-none bg-white rounded-xl p-4 text-xs" value="${data.dob || ''}">
                </div>
                <textarea placeholder="تفاصيل المرض" class="h-desc w-full border-none bg-white rounded-xl p-4 text-xs" rows="2">${data.desc || ''}</textarea>
                <button type="button" onclick="this.parentElement.remove()" class="absolute -left-2 -top-2 bg-white text-red-500 w-8 h-8 rounded-full shadow-md border flex items-center justify-center font-black">×</button>
            `;
            document.getElementById('healthList').appendChild(div);
        }

        async function handleSave(e) {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            
            // التحقق من الصلاحيات
            if(window.currentUserData.role === 'beneficiary' && editId !== window.currentUserData.id) return alert("غير مصرح لك");
            if(window.currentUserData.role !== 'beneficiary') {
                if(editId && !hasPerm('edit')) return alert("ليس لديك صلاحية تعديل");
                if(!editId && !hasPerm('add')) return alert("ليس لديك صلاحية إضافة");
            }

            // التحقق من إجبارية تواريخ الميلاد للمستفيد
            if (window.currentUserData.role === 'beneficiary') {
                if (!document.getElementById('pDob').value) {
                    return alert("يرجى تعبئة تاريخ ميلاد رب الأسرة، فهو حقل إجباري.");
                }

                const wifeName = document.getElementById('wifeName').value;
                if (wifeName && wifeName.trim() !== '' && !document.getElementById('wifeDob').value) {
                    return alert("يرجى تعبئة تاريخ ميلاد الزوجة، فهو حقل إجباري.");
                }

                const memberRows = document.querySelectorAll('.member-row');
                for (const row of memberRows) {
                    const memberName = row.querySelector('.m-name').value;
                    const memberDob = row.querySelector('.m-dob').value;
                    if (memberName && memberName.trim() !== '' && !memberDob) {
                        alert(`يرجى تعبئة تاريخ ميلاد الفرد "${memberName}"، فهو حقل إجباري.`);
                        return;
                    }
                }
            }

            // حساب الأعداد تلقائياً بناءً على المدخلات
            const counts = calculateFamilyCounts();

            const payload = {
                pName: document.getElementById('pName').value,
                pId: document.getElementById('pId').value,
                pIdIssue: document.getElementById('pIdIssue').value,
                pDob: document.getElementById('pDob').value,
                pPhone: document.getElementById('pPhone').value,
                pSocial: document.getElementById('pSocial').value,
                wifeName: document.getElementById('wifeName').value,
                wifeId: document.getElementById('wifeId').value,
                wifeDob: document.getElementById('wifeDob').value,
                pDelegate: document.getElementById('pDelegate').value,
                pAltPhone: document.getElementById('pAltPhone').value,
                originArea: document.getElementById('originArea').value,
                displaceArea: document.getElementById('displaceArea').value,
                totalCount: counts.total,
                maleCount: counts.male,
                femaleCount: counts.female,
                walletOwner: document.getElementById('walletOwner').value,
                walletId: document.getElementById('walletId').value,
                walletPhone: document.getElementById('walletPhone').value,
                members: Array.from(document.querySelectorAll('.member-row')).map(r => ({
                    name: r.querySelector('.m-name').value,
                    relation: r.querySelector('.m-rel').value,
                    dob: r.querySelector('.m-dob').value,
                    idNum: r.querySelector('.m-id').value
                })),
                health: Array.from(document.querySelectorAll('.health-row')).map(r => ({
                    type: r.querySelector('.h-type').value,
                    name: r.querySelector('.h-name').value,
                    idNum: r.querySelector('.h-id').value,
                    phone: r.querySelector('.h-phone').value,
                    dob: r.querySelector('.h-dob').value,
                    desc: r.querySelector('.h-desc').value
                })),
                updatedAt: new Date().toISOString()
            };

            // حماية إضافية: منع المستفيد من تغيير المندوب حتى لو تلاعب بالحقل
            if (window.currentUserData.role === 'beneficiary') {
                const original = window.families.find(f => f.id === editId);
                if (original) payload.pDelegate = original.pDelegate;
            }

            try {
                if (editId) {
                    await window.fs.updateDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "families", editId), payload);
                } else {
                    await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "families"), payload);
                }
                closeModal('formModal');
            } catch (err) { alert("خطأ في التخزين السحابي: " + err.message); }
        }

        async function editFamily(id) {
            if(window.currentUserData.role !== 'beneficiary' && !hasPerm('edit')) return alert("ليس لديك صلاحية تعديل");
            
            const f = window.families.find(x => x.id === id);
            if(!f) return;
            openForm();
            document.getElementById('editId').value = f.id;
            document.getElementById('modalTitle').innerText = 'تعديل بيانات العائلة';
            
            Object.keys(f).forEach(key => {
                const el = document.getElementById(key);
                if(el && key !== 'members' && key !== 'health') el.value = f[key] || '';
            });

            if(f.members) f.members.forEach(m => addMemberRow(m));
            if(f.health) f.health.forEach(h => addHealthRow(h));
            
            calculateFamilyCounts();

            // تعطيل حقل المندوب للمستفيدين فقط
            if (window.currentUserData.role === 'beneficiary') {
                const delInput = document.getElementById('pDelegate');
                delInput.disabled = true;
                delInput.classList.remove('bg-slate-50');
                delInput.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
            }

            document.getElementById('formModal').classList.remove('hidden');
        }

        function triggerDelete(id) {
            if(!hasPerm('remove')) return alert("ليس لديك صلاحية حذف");
            pendingDeleteId = id;
            document.getElementById('undoToast').classList.remove('hidden');
            deleteTimer = setTimeout(async () => {
                if(pendingDeleteId) {
                    await window.fs.deleteDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "families", pendingDeleteId));
                }
                document.getElementById('undoToast').classList.add('hidden');
                pendingDeleteId = null;
            }, 5000);
        }

        function cancelDelete() {
            clearTimeout(deleteTimer);
            pendingDeleteId = null;
            document.getElementById('undoToast').classList.add('hidden');
        }

        async function viewDetails(id) {
            const f = window.families.find(x => x.id === id);
            if(!f) return;
            
            const isRestricted = window.currentUserData?.role === 'viewer' && !hasPerm('view_all');
            const mask = (val) => isRestricted ? '*****' : (val || "-");

            const pAge = getAge(f.pDob);
            const wAge = getAge(f.wifeDob);
            
            let html = '';
            
            if (isRestricted) {
                html = `
                    <div class="flex items-center gap-8 mb-12">
                        <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center text-4xl text-white font-black shadow-xl shadow-indigo-100">${(f.pName || "?")[0]}</div>
                        <div>
                            <h2 class="text-4xl font-black text-slate-800">${f.pName || "غير متوفر"}</h2>
                            <p class="text-indigo-500 font-bold tracking-widest uppercase text-sm mt-2">مندوب التوزيع: ${f.pDelegate || "غير محدد"}</p>
                        </div>
                    </div>
                    <div class="p-10 bg-slate-50 rounded-3xl text-center text-slate-400 font-bold">
                        لا تملك صلاحية لعرض باقي التفاصيل
                    </div>
                `;
            } else {
                html = `
                    <div class="flex items-center gap-8 mb-12">
                        <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center text-4xl text-white font-black shadow-xl shadow-indigo-100">${(f.pName || "?")[0]}</div>
                        <div>
                            <h2 class="text-4xl font-black text-slate-800">${f.pName || "غير متوفر"}</h2>
                            <p class="text-indigo-500 font-bold tracking-widest uppercase text-sm mt-2">مندوب التوزيع: ${f.pDelegate || "غير محدد"}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-16">
                        <div class="space-y-8">
                            <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4">المعلومات الشخصية</h3>
                            <div class="grid grid-cols-2 gap-y-6 text-sm">
                                <span class="text-slate-400">رقم الهوية:</span> <span class="font-mono font-bold">${mask(f.pId)}</span>
                                <span class="text-slate-400">اصدار الهوية:</span> <span class="font-bold">${f.pIdIssue || "-"}</span>
                                <span class="text-slate-400">تاريخ الميلاد:</span> <span class="font-bold">${f.pDob || "-"} (${pAge.y} سنة، ${pAge.m} شهر)</span>
                                <span class="text-slate-400">رقم الجوال:</span> <span class="font-mono font-bold">${isRestricted ? '*****' : '0' + (f.pPhone || "-")}</span>
                                <span class="text-slate-400">جوال بديل:</span> <span class="font-mono font-bold">${isRestricted ? '*****' : '0' + (f.pAltPhone || "-")}</span>
                                <span class="text-slate-400">الحالة الاجتماعية:</span> <span class="font-bold">${f.pSocial || "-"}</span>
                                <span class="text-slate-400">السكن الأصلي:</span> <span class="font-bold">${f.originArea || "-"}</span>
                                <span class="text-slate-400">منطقة النزوح:</span> <span class="font-bold">${f.displaceArea || "-"}</span>
                            </div>
                        </div>
                        <div class="space-y-8">
                            <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4">بيانات الزوجة</h3>
                            <div class="grid grid-cols-2 gap-y-6 text-sm">
                                <span class="text-slate-400">الاسم:</span> <span class="font-bold">${f.wifeName || "غير محدد"}</span>
                                <span class="text-slate-400">الهوية:</span> <span class="font-mono font-bold">${mask(f.wifeId)}</span>
                                <span class="text-slate-400">تاريخ الميلاد:</span> <span class="font-bold">${f.wifeDob || "-"}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-16">
                        <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4 mb-8">أفراد العائلة المضافين (${f.members?.length || 0})</h3>
                        <div class="bg-slate-50 rounded-[3rem] p-10 overflow-x-auto">
                            <table class="w-full text-right text-xs">
                                <thead class="text-slate-400 border-b border-slate-200">
                                    <tr><th class="pb-4">الاسم</th><th class="pb-4">الصلة</th><th class="pb-4">تاريخ الميلاد</th><th class="pb-4">العمر</th><th class="pb-4">الهوية</th></tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${(f.members || []).map(m => {
                                        const age = getAge(m.dob);
                                        return `<tr><td class="py-4 font-bold text-slate-700">${m.name || "-"}</td><td>${m.relation || "-"}</td><td>${m.dob || "-"}</td><td>${age.y} سنة، ${age.m} شهر</td><td class="font-mono">${mask(m.idNum)}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mt-16">
                        <div class="p-10 bg-red-50 rounded-[3rem] border border-red-100">
                            <h3 class="text-red-600 font-black mb-6">الحالات الصحية</h3>
                            ${(f.health || []).map(h => `
                                <div class="mb-4 bg-white p-6 rounded-2xl shadow-sm">
                                    <div class="flex justify-between font-black text-slate-800 mb-3 border-b pb-2">
                                        <span>${h.name || "بدون اسم"}</span>
                                        <span class="text-red-500 text-xs bg-red-50 px-2 py-1 rounded-lg">${h.type || "-"}</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-500 mb-3">
                                        <div><span class="text-slate-400">الهوية:</span> <span class="font-mono font-bold">${mask(h.idNum)}</span></div>
                                        <div><span class="text-slate-400">الجوال:</span> <span class="font-mono font-bold">${mask(h.phone)}</span></div>
                                        <div class="col-span-2"><span class="text-slate-400">الميلاد:</span> <span class="font-bold">${h.dob || "-"}</span></div>
                                    </div>
                                    <div class="text-[11px] text-slate-600 bg-slate-50 p-3 rounded-xl">
                                        <span class="font-bold block mb-1">التفاصيل:</span>
                                        ${h.desc || "لا يوجد تفاصيل إضافية"}
                                    </div>
                                </div>
                            `).join('') || '<p class="text-xs text-red-300">لا يوجد سجلات مرضية</p>'}
                        </div>
                        <div class="p-10 bg-emerald-50 rounded-[3rem] border border-emerald-100">
                            <h3 class="text-emerald-600 font-black mb-6">المحفظة الإلكترونية</h3>
                            <div class="space-y-4 text-sm">
                                <div class="flex justify-between"><span>المالك:</span><span class="font-bold">${f.walletOwner || "-"}</span></div>
                                <div class="flex justify-between"><span>الهوية:</span><span class="font-mono">${mask(f.walletId)}</span></div>
                                <div class="flex justify-between"><span>الجوال:</span><span class="font-mono">${isRestricted ? '*****' : '0' + (f.walletPhone || "-")}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-16">
                        <h3 class="text-xs font-black text-slate-300 uppercase tracking-[0.2em] border-b pb-4 mb-8">سجل الاستفادة</h3>
                        <div id="benefitHistoryContainer" class="bg-slate-50 rounded-[3rem] p-10 overflow-x-auto">
                            <p class="text-center text-slate-400">جاري تحميل السجل...</p>
                        </div>
                    </div>
                `;
            }

            document.getElementById('detailsContent').innerHTML = html;
            
            const actionContainer = document.getElementById('detailActions');
            actionContainer.innerHTML = ''; 

            if(hasPerm('view_sensitive') || window.currentUserData.role !== 'viewer') {
                const exportBtn = document.createElement('button');
                exportBtn.className = "px-6 py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 shadow-xl shadow-indigo-100 flex items-center gap-2";
                exportBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> تصدير إكسل`;
                exportBtn.onclick = () => exportSingleToExcel(f);
                actionContainer.appendChild(exportBtn);

                const printBtn = document.createElement('button');
                printBtn.className = "px-6 py-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 shadow-xl flex items-center gap-2";
                printBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg> طباعة PDF`;
                printBtn.onclick = () => printFamilyDetails(f);
                actionContainer.appendChild(printBtn);
            }
            
            document.getElementById('detailsModal').classList.remove('hidden');
            if (!isRestricted) {
                await fetchAndRenderBenefitHistory(id);
            }
        }

        async function fetchAndRenderBenefitHistory(familyId) {
            const container = document.getElementById('benefitHistoryContainer');
            try {
                const q = window.fs.query(
                    window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"),
                    window.fs.where("familyIds", "array-contains", familyId)
                );
                const snap = await window.fs.getDocs(q);

                if (snap.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400">لا يوجد سجل استفادة لهذه العائلة.</p>';
                    return;
                }

                let docs = [];
                snap.forEach(doc => docs.push(doc.data()));
                docs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                let historyHTML = `
                    <table class="w-full text-right text-sm">
                        <thead class="text-slate-400 border-b border-slate-200">
                            <tr><th class="pb-4">الأستفادة</th><th class="pb-4">تاريخ الاستفادة</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                `;
                let hasRecords = false;
                docs.forEach(d => {
                    // عرض السجلات من فئة "سجل المستفيدين" فقط
                    if (d.category === 'beneficiaries') {
                        historyHTML += `<tr><td class="py-4 font-bold text-slate-700">${d.fileName}</td><td class="font-mono">${d.date}</td></tr>`;
                        hasRecords = true;
                    }
                });
                historyHTML += '</tbody></table>';
                container.innerHTML = hasRecords ? historyHTML : '<p class="text-center text-slate-400">لا يوجد سجل استفادة لهذه العائلة في سجل المستفيدين.</p>';

            } catch (e) {
                console.error("Error fetching benefit history:", e);
                container.innerHTML = '<p class="text-center text-red-500">حدث خطأ أثناء تحميل السجل.</p>';
            }
        }

        function downloadTemplate() { 
            const headers = ["اسم رب الأسرة", "تاريخ ميلاد رب الأسرة", "هوية رب الأسرة", "اصدار الهوية", "رقم الجوال", "اسم الزوجة", "هوية الزوجة", "تاريخ ميلاد الزوجة", "الحالة الاجتماعية", "عدد الأفراد الكلي", "عدد الذكور", "عدد الإناث"];
            for(let i=1; i<=10; i++) headers.push(`اسم الفرد ${i}`, `صلة القرابة ${i}`, `تاريخ الميلاد الفرد ${i}`, `رقم الهوية الفرد ${i}`);
            headers.push("منطقة السكن الأصلية", "منطقة النزوح", "المندوب", "جوال بديل");
            for(let i=1; i<=5; i++) headers.push(`الاسم الحالة ${i}`, `رقم الهوية الحالة ${i}`, `رقم الجوال الحالة ${i}`, `نوع المرض ${i}`);
            headers.push("اسم المالك المحفظة", "رقم الهوية المحفظة", "رقم الجوال المحفظة");
            const ws = XLSX.utils.aoa_to_sheet([headers]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "النموذج_الشامل_للعائلات.xlsx");
        }

        function openImportModal() {
            if(!hasPerm('add')) return alert("ليس لديك صلاحية استيراد");
            document.getElementById('impFileName').value = '';
            document.getElementById('impType').value = '';
            document.getElementById('impDonor').value = '';
            document.getElementById('impDate').valueAsDate = new Date();
            document.getElementById('importModal').classList.remove('hidden');
        }

        function triggerImportFile() {
            const vFileName = document.getElementById('impFileName').value.trim();
            const vType = document.getElementById('impType').value.trim();
            const vDonor = document.getElementById('impDonor').value.trim();
            const vDate = document.getElementById('impDate').value;

            if (!vFileName || !vType || !vDonor || !vDate) {
                return alert("يرجى تعبئة جميع حقول الأرشفة (اسم الملف، النوع، الجهة المانحة، التاريخ) قبل الاستيراد");
            }
            document.getElementById('realImportInput').click();
        }

        async function executeImport(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const vFileName = document.getElementById('impFileName').value.trim();
            const vType = document.getElementById('impType').value.trim();
            const vDonor = document.getElementById('impDonor').value.trim();
            const vDate = document.getElementById('impDate').value;

            const reader = new FileReader();
            reader.onload = async (evt) => {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let successCount = 0;
                for (let row of rawData) {
                    let obj = {
                        updatedAt: new Date().toISOString(),
                        pName: row["اسم رب الأسرة"] || "",
                        pDob: row["تاريخ ميلاد رب الأسرة"] || "",
                        pId: String(row["هوية رب الأسرة"] || ""),
                        pIdIssue: String(row["اصدار الهوية"] || ""),
                        pPhone: String(row["رقم الجوال"] || ""),
                        wifeName: row["اسم الزوجة"] || "",
                        wifeId: String(row["هوية الزوجة"] || ""),
                        wifeDob: row["تاريخ ميلاد الزوجة"] || "",
                        pSocial: row["الحالة الاجتماعية"] || "",
                        totalCount: row["عدد الأفراد الكلي"] || "",
                        maleCount: row["عدد الذكور"] || "",
                        femaleCount: row["عدد الإناث"] || "",
                        originArea: row["منطقة السكن الأصلية"] || "",
                        displaceArea: row["منطقة النزوح"] || "",
                        pDelegate: row["المندوب"] || "",
                        pAltPhone: String(row["جوال بديل"] || ""),
                        walletOwner: row["اسم المالك المحفظة"] || "",
                        walletId: String(row["رقم الهوية المحفظة"] || ""),
                        walletPhone: String(row["رقم الجوال المحفظة"] || "")
                    };
                    let members = [];
                    for(let i=1; i<=10; i++) {
                        if(row[`اسم الفرد ${i}`]) {
                            members.push({
                                name: row[`اسم الفرد ${i}`],
                                relation: row[`صلة القرابة ${i}`] || "",
                                dob: row[`تاريخ الميلاد الفرد ${i}`] || "",
                                idNum: String(row[`رقم الهوية الفرد ${i}`] || "")
                            });
                        }
                    }
                    obj.members = members;
                    let health = [];
                    for(let i=1; i<=5; i++) {
                        if(row[`الاسم الحالة ${i}`]) {
                            health.push({ name: row[`الاسم الحالة ${i}`], idNum: String(row[`رقم الهوية الحالة ${i}`] || ""), phone: String(row[`رقم الجوال الحالة ${i}`] || ""), type: row[`نوع المرض ${i}`] || "", desc: "" });
                        }
                    }
                    obj.health = health;
                    if(obj.pName && obj.pId) {
                        try { await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "families"), obj); successCount++; } catch(err) { console.error("Import Error", err); }
                    }
                }
                    
                    // Log Import to Archive
                    try {
                        await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), {
                            fileName: vFileName,
                            type: vType,
                            donor: vDonor,
                            date: vDate,
                            count: successCount,
                            createdAt: new Date().toISOString(),
                            createdBy: window.currentUserData ? window.currentUserData.name : 'Unknown',
                            notes: 'تم استيراد البيانات من ملف خارجي: ' + file.name,
                            fileStatus: 'مرفوع',
                            category: 'archive'
                        });
                    } catch(e) { console.error("Archive Log Error", e); }

                alert(`تم استيراد ${successCount} عائلة بنجاح`);
                location.reload(); 
            };
            reader.readAsBinaryString(file);
            closeModal('importModal');
        }

        function exportSingleToExcel(f) {
            const wb = XLSX.utils.book_new();
            const data = [];
            data.push(["البيانات الأساسية للعائلة"]);
            data.push(["اسم رب الأسرة", f.pName || "", "رقم الهوية", f.pId || ""]);
            data.push(["تاريخ الميلاد", f.pDob || "", "رقم الجوال", f.pPhone || "", "اصدار الهوية", f.pIdIssue || ""]);
            data.push(["الحالة الاجتماعية", f.pSocial || "", "المندوب", f.pDelegate || ""]);
            data.push(["اسم الزوجة", f.wifeName || "", "هوية الزوجة", f.wifeId || ""]);
            data.push(["تاريخ ميلاد الزوجة", f.wifeDob || "", "جوال بديل", f.pAltPhone || ""]);
            data.push(["السكن الأصلي", f.originArea || "", "منطقة النزوح", f.displaceArea || ""]);
            data.push(["إجمالي الأفراد", f.totalCount || 0, "عدد الذكور", f.maleCount || 0, "عدد الإناث", f.femaleCount || 0]);
            data.push([]); 
            data.push(["أفراد العائلة المضافين"]);
            data.push(["الاسم", "الصلة", "تاريخ الميلاد", "العمر", "رقم الهوية"]);
            if(f.members && f.members.length > 0) {
                f.members.forEach(m => { const age = getAge(m.dob); data.push([m.name || "", m.relation || "", m.dob || "", `${age.y} سنة`, m.idNum || ""]); });
            } else { data.push(["لا يوجد أفراد مضافين"]); }
            data.push([]); 
            data.push(["الحالات الصحية الخاصة"]);
            data.push(["الاسم", "نوع الحالة", "رقم الهوية", "رقم الجوال", "تاريخ الميلاد", "التفاصيل"]);
            if(f.health && f.health.length > 0) {
                f.health.forEach(h => { data.push([h.name || "", h.type || "", h.idNum || "", h.phone || "", h.dob || "", h.desc || ""]); });
            } else { data.push(["لا يوجد سجلات صحية"]); }
            data.push([]); 
            data.push(["بيانات المحفظة الإلكترونية"]);
            data.push(["اسم المالك", f.walletOwner || "", "رقم الهوية", f.walletId || "", "رقم الجوال", f.walletPhone || ""]);
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 25}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 40}];
            XLSX.utils.book_append_sheet(wb, ws, "تقرير العائلة");
            XLSX.writeFile(wb, `بيانات_عائلة_${f.pName}.xlsx`);
        }

        function printFamilyDetails(f) {
            const pAge = getAge(f.pDob);
            let printHTML = `
                <div class="print-container">
                    <div class="print-header"><h1 class="print-title">استمارة بيانات عائلة</h1><p class="print-meta">تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p></div>
                    <div class="section-title">1. البيانات الأساسية</div>
                    <div class="info-grid">
                        <table class="print-table"><tr><th>رب الأسرة</th><td>${f.pName || '-'}</td></tr><tr><th>رقم الهوية</th><td>${f.pId || '-'}</td></tr><tr><th>اصدار الهوية</th><td>${f.pIdIssue || '-'}</td></tr><tr><th>رقم الجوال</th><td>${f.pPhone || '-'}</td></tr><tr><th>تاريخ الميلاد</th><td>${f.pDob || '-'} (${pAge.y} سنة)</td></tr></table>
                        <table class="print-table"><tr><th>الزوجة</th><td>${f.wifeName || '-'}</td></tr><tr><th>هوية الزوجة</th><td>${f.wifeId || '-'}</td></tr><tr><th>السكن الأصلي</th><td>${f.originArea || '-'}</td></tr><tr><th>منطقة النزوح</th><td>${f.displaceArea || '-'}</td></tr></table>
                    </div>
                    <table class="print-table" style="margin-top: 10px;"><tr><th>المندوب</th><td>${f.pDelegate || '-'}</td><th>الحالة الاجتماعية</th><td>${f.pSocial || '-'}</td><th>عدد الأفراد</th><td>${f.totalCount || '0'}</td></tr></table>
                    <div class="section-title">2. أفراد العائلة (${f.members ? f.members.length : 0})</div>
                    <table class="print-table"><thead><tr><th style="width: 30%">الاسم</th><th style="width: 15%">الصلة</th><th style="width: 15%">تاريخ الميلاد</th><th style="width: 15%">العمر</th><th style="width: 25%">رقم الهوية</th></tr></thead><tbody>
            `;
            if(f.members && f.members.length > 0) { f.members.forEach(m => { const age = getAge(m.dob); printHTML += `<tr><td>${m.name || '-'}</td><td>${m.relation || '-'}</td><td>${m.dob || '-'}</td><td>${age.y} سنة</td><td>${m.idNum || '-'}</td></tr>`; }); } else { printHTML += `<tr><td colspan="5" style="text-align: center; padding: 15px;">لا يوجد أفراد مضافين</td></tr>`; }
            printHTML += `</tbody></table><div class="section-title">3. الحالات الصحية</div><table class="print-table"><thead><tr><th style="width: 25%">الاسم</th><th style="width: 20%">نوع المرض</th><th style="width: 20%">رقم الهوية</th><th style="width: 35%">التفاصيل</th></tr></thead><tbody>`;
             if(f.health && f.health.length > 0) { f.health.forEach(h => { printHTML += `<tr><td>${h.name || '-'}</td><td>${h.type || '-'}</td><td>${h.idNum || '-'}</td><td>${h.desc || '-'}</td></tr>`; }); } else { printHTML += `<tr><td colspan="4" style="text-align: center; padding: 15px;">لا يوجد حالات صحية مسجلة</td></tr>`; }
            printHTML += `</tbody></table><div class="section-title">4. المحفظة الإلكترونية</div><table class="print-table"><tr><th width="15%">اسم المالك</th><td width="35%">${f.walletOwner || '-'}</td><th width="15%">رقم الهوية</th><td width="35%">${f.walletId || '-'}</td></tr><tr><th>رقم الجوال</th><td colspan="3">${f.walletPhone || '-'}</td></tr></table></div>`;
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = printHTML;
            window.print();
        }

        function openMainExportModal() {
            const checks = document.querySelectorAll('.main-row-check:checked');
            const count = checks.length > 0 ? checks.length : currentViewData.length;
            
            document.getElementById('meCountDisplay').innerText = count;
            document.getElementById('meArchiveDate').innerText = new Date().toLocaleDateString('ar-EG');
            document.getElementById('meDate').valueAsDate = new Date();
            
            document.getElementById('mainExportModal').classList.remove('hidden');
        }

        async function executeMainExport() {
            const vFileName = document.getElementById('meFileName').value.trim();
            const vType = document.getElementById('meType').value.trim();
            const vDonor = document.getElementById('meDonor').value.trim();
            const vDate = document.getElementById('meDate').value;

            if (!vFileName || !vType || !vDonor || !vDate) {
                return alert("يرجى تعبئة جميع حقول الأرشفة (اسم الملف، النوع، الجهة المانحة، التاريخ) قبل التصدير");
            }

            const checks = document.querySelectorAll('.main-row-check:checked');
            let dataToExport = [];
            
            if (checks.length > 0) {
                // Export selected only
                checks.forEach(cb => {
                    const idx = parseInt(cb.getAttribute('data-index'));
                    if(currentViewData[idx]) dataToExport.push(currentViewData[idx]);
                });
            } else {
                // Export all in view
                dataToExport = currentViewData;
            }

            // Archive Meta
            const meta = {
                fileName: vFileName,
                type: vType,
                donor: vDonor,
                date: vDate,
                count: dataToExport.length,
                createdAt: new Date().toISOString(),
                createdBy: window.currentUserData ? window.currentUserData.name : 'Unknown',
                notes: 'تصدير من الجدول الرئيسي',
                fileStatus: 'تنزيل',
                category: 'archive'
            };

            try {
                await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), meta);
            } catch(e) {
                console.error("Archiving failed", e);
            }

            let dataForExcel = [];
            if (currentViewMode === 'individual') {
                dataForExcel = dataToExport.map(d => ({ "اسم الفرد": d.targetName, "هوية الفرد": d.targetId, "العمر/الصلة": `${d.targetAge} (${d.relation})`, "اسم الأب": d.pName, "هوية الأب": d.pId, "اسم الزوجة": d.wifeName, "هوية الزوجة": d.wifeId, "رقم الجوال": d.pPhone }));
            } else if (currentViewMode === 'health') {
                dataForExcel = dataToExport.map(d => ({ "اسم المريض": d.patientName, "هوية المريض": d.patientId, "تاريخ الميلاد": d.patientDob, "نوع المرض": d.diseaseType, "تفاصيل المرض": d.diseaseDesc, "اسم الأب": d.pName, "هوية الأب": d.pId, "اسم الزوجة": d.wifeName, "هوية الزوجة": d.wifeId, "رقم الجوال": d.pPhone }));
            } else {
                dataForExcel = dataToExport.map(d => ({ "اسم الأب": d.pName, "هوية الأب": d.pId, "اسم الزوجة": d.wifeName, "هوية الزوجة": d.wifeId, "رقم الجوال": d.pPhone, "المندوب": d.pDelegate, "الحالة الاجتماعية": d.pSocial, "إجمالي الأفراد": d.totalCount }));
            }
            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Export");
            XLSX.writeFile(wb, `${meta.fileName}.xlsx`);
            closeModal('mainExportModal');
        }

        function openExportModal() {
            const container = document.getElementById('exportFieldCheckboxes');
            container.innerHTML = '';
            Object.keys(FIELD_MAP).forEach(k => { container.innerHTML += `<label class="flex items-center gap-3 p-4 bg-white rounded-2xl border border-slate-100 hover:border-indigo-200 cursor-pointer transition-all"><input type="checkbox" value="${k}" checked class="w-5 h-5 rounded-lg text-indigo-600 focus:ring-indigo-500"><span class="text-xs font-bold text-slate-600">${FIELD_MAP[k]}</span></label>`; });
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function openCustomExportMetaModal() {
            const count = window.families.length;
            document.getElementById('ceCountDisplay').innerText = count;
            document.getElementById('ceArchiveDate').innerText = new Date().toLocaleDateString('ar-EG');
            document.getElementById('ceDate').valueAsDate = new Date();
            document.getElementById('customExportMetaModal').classList.remove('hidden');
        }

        async function executeCustomExport() {
            const vFileName = document.getElementById('ceFileName').value.trim();
            const vType = document.getElementById('ceType').value.trim();
            const vDonor = document.getElementById('ceDonor').value.trim();
            const vDate = document.getElementById('ceDate').value;

            if (!vFileName || !vType || !vDonor || !vDate) {
                return alert("يرجى تعبئة جميع حقول الأرشفة (اسم الملف، النوع، الجهة المانحة، التاريخ) قبل التصدير");
            }

            // Archive Meta
            const meta = {
                fileName: vFileName,
                type: vType,
                donor: vDonor,
                date: vDate,
                count: window.families.length,
                createdAt: new Date().toISOString(),
                createdBy: window.currentUserData ? window.currentUserData.name : 'Unknown',
                notes: 'تصدير مخصص (أعمدة محددة)',
                fileStatus: 'تنزيل',
                category: 'archive'
            };

            try {
                await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), meta);
            } catch(e) {
                console.error("Archiving failed", e);
            }

            const selected = Array.from(document.querySelectorAll('#exportFieldCheckboxes input:checked')).map(i => i.value);
            const data = window.families.map(f => { let obj = {}; selected.forEach(k => obj[FIELD_MAP[k]] = f[k] || ""); return obj; });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CustomExport");
            XLSX.writeFile(wb, `${meta.fileName}.xlsx`);
            closeModal('customExportMetaModal');
            closeModal('exportModal');
        }

        function toggleDuplicateFilter() {
            showDupsOnly = !showDupsOnly;
            document.getElementById('dupIconBox').className = showDupsOnly ? "w-16 h-16 bg-red-600 rounded-2xl flex items-center justify-center text-white" : "w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center text-red-600";
            runFilters();
        }

        // ===========================================
        //       Beneficiaries System Logic
        // ===========================================

        function openBeneficiaries() {
            document.getElementById('beneficiariesModal').classList.remove('hidden');
            switchBenTab('new');
            renderBeneficiariesTable();
        }

        function renderBeneficiariesTable() {
            const tbody = document.getElementById('benTableBody');
            const search = (document.getElementById('benSearch').value || '').toLowerCase();
            tbody.innerHTML = '';
            window.families.forEach(f => {
                if(search && !f.pName.includes(search) && !f.pId.includes(search)) return;
                
                let count = 1;
                if(f.wifeName && f.wifeName.trim()) count++;
                if(f.members && Array.isArray(f.members)) count += f.members.length;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50 transition-all border-b border-slate-50";
                tr.innerHTML = `<td class="p-3"><input type="checkbox" value="${f.id}" onchange="updateBenSelection()" class="ben-check w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500 cursor-pointer"></td><td class="p-3 font-bold">${f.pName}</td><td class="p-3 font-mono text-slate-500">${f.pId}</td><td class="p-3 font-mono text-slate-500">${f.pPhone}</td><td class="p-3 font-bold text-center">${f.totalCount}</td><td class="p-3 text-xs font-bold text-indigo-600">${f.pDelegate || '-'}</td>`;
                tr.innerHTML = `<td class="p-3"><input type="checkbox" value="${f.id}" onchange="updateBenSelection()" class="ben-check w-5 h-5 rounded text-emerald-600 focus:ring-emerald-500 cursor-pointer"></td><td class="p-3 font-bold">${f.pName}</td><td class="p-3 font-mono text-slate-500">${f.pId}</td><td class="p-3 font-mono text-slate-500">${f.pPhone}</td><td class="p-3 font-bold text-center">${count}</td><td class="p-3 text-xs font-bold text-indigo-600">${f.pDelegate || '-'}</td>`;
                tbody.appendChild(tr);
            });
            updateBenSelection();
        }

        function updateBenSelection() {
            const checks = document.querySelectorAll('.ben-check:checked');
            const count = checks.length;
            document.getElementById('selectedCountBadge').innerText = count;
            const panel = document.getElementById('exportPanel');
            const hint = document.getElementById('selectHint');
            if(count > 0) { panel.classList.remove('opacity-50', 'pointer-events-none'); hint.classList.add('hidden'); }
            else { panel.classList.add('opacity-50', 'pointer-events-none'); hint.classList.remove('hidden'); }
        }

        function selectAllBen(select) {
            document.querySelectorAll('.ben-check').forEach(cb => cb.checked = select);
            updateBenSelection();
        }

        async function executeBenExport() {
            const checks = document.querySelectorAll('.ben-check:checked');
            if(checks.length === 0) return;

            const vFileName = document.getElementById('expFileName').value.trim();
            const vFileType = document.getElementById('expFileType').value.trim();
            const vDonor = document.getElementById('expDonor').value.trim();
            const vDate = document.getElementById('expDate').value;

            if (!vFileName || !vFileType || !vDonor || !vDate) {
                return alert("يرجى تعبئة جميع حقول الأرشفة (اسم الملف، النوع، الجهة المانحة، التاريخ) قبل التصدير");
            }

            const ids = Array.from(checks).map(cb => cb.value);
            const selectedFamilies = window.families.filter(f => ids.includes(f.id));
            const meta = {
                fileName: vFileName,
                type: vFileType,
                donor: vDonor,
                date: vDate,
                notes: document.getElementById('expNotes').value || '-',
                familyIds: ids,
                count: ids.length,
                createdAt: new Date().toISOString(),
                createdBy: window.currentUserData.name,
                fileStatus: 'تنزيل',
                category: 'beneficiaries'
            };

            try {
                await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), meta);
            } catch(e) {
                console.error("Archiving failed", e);
                alert("تحذير: فشل حفظ الأرشيف في قاعدة البيانات، سيتم تحميل الملف فقط.");
            }

            const wb = XLSX.utils.book_new();
            const data = [["تقرير المستفيدين - نظام الأرشفة"], ["اسم الملف", meta.fileName, "نوع المساعدة", meta.type], ["الجهة المانحة", meta.donor, "تاريخ الاستفادة", meta.date], ["ملاحظات", meta.notes], [], ["اسم رب الأسرة", "رقم الهوية", "رقم الجوال", "عدد الأفراد", "المندوب", "الزوجة", "هوية الزوجة"]];
            selectedFamilies.forEach(f => { data.push([f.pName, f.pId, f.pPhone, f.totalCount, f.pDelegate, f.wifeName, f.wifeId]); });
            selectedFamilies.forEach(f => { 
                let count = 1;
                if(f.wifeName && f.wifeName.trim()) count++;
                if(f.members && Array.isArray(f.members)) count += f.members.length;
                data.push([f.pName, f.pId, f.pPhone, count, f.pDelegate, f.wifeName, f.wifeId]); 
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 15}, {wch: 10}, {wch: 15}, {wch: 20}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, ws, "المستفيدين");
            XLSX.writeFile(wb, `${meta.fileName}.xlsx`);
            alert("تم تصدير الملف بنجاح");
            switchBenTab('beneficiaries');
        }

        // ===========================================
        //       Match Import Logic
        // ===========================================

        window.triggerMatchImport = function() {
            document.getElementById('matchImportInput').click();
        };

        window.processMatchImport = function(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Extract IDs (assuming column name contains 'هوية' or is the first column)
                const extractedIds = [];
                rawData.forEach(row => {
                    // Try to find ID in common column names or values
                    const val = row['رقم الهوية'] || row['الهوية'] || row['ID'] || Object.values(row)[0]; 
                    if(val) extractedIds.push(String(val).trim());
                });

                // Find matches in DB
                const matches = window.families.filter(f => extractedIds.includes(f.pId));
                matchedIdsForArchive = matches.map(f => f.id);

                if(matchedIdsForArchive.length === 0) {
                    alert("لم يتم العثور على أي مطابقة لأرقام الهويات في الملف");
                    return;
                }

                // Open Metadata Modal
                document.getElementById('matchCountDisplay').innerText = matchedIdsForArchive.length;
                document.getElementById('mmFileName').value = file.name.replace('.xlsx', '').replace('.xls', '');
                document.getElementById('mmDate').valueAsDate = new Date();
                document.getElementById('matchMetadataModal').classList.remove('hidden');
            };
            reader.readAsBinaryString(file);
            e.target.value = ''; // Reset input
        };

        window.executeMatchArchive = async function() {
            const meta = {
                fileName: document.getElementById('mmFileName').value || 'ملف مطابقة',
                type: document.getElementById('mmType').value || 'مطابقة',
                donor: document.getElementById('mmDonor').value || '-',
                date: document.getElementById('mmDate').value || new Date().toLocaleDateString('ar-EG'),
                count: matchedIdsForArchive.length,
                familyIds: matchedIdsForArchive,
                createdAt: new Date().toISOString(),
                createdBy: window.currentUserData.name,
                fileStatus: 'مرفوع', // As requested: Imported files are "Uploaded"
                notes: 'تم إنشاء السجل عن طريق استرداد ملف ومطابقة الهويات',
                category: 'beneficiaries'
            };

            try {
                await window.fs.addDoc(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), meta);
                closeModal('matchMetadataModal');
                switchBenTab('beneficiaries'); // Switch to Beneficiaries Record
                alert("تم حفظ السجل في سجل المستفيدين بنجاح");
            } catch(e) {
                console.error(e);
                alert("حدث خطأ أثناء الحفظ");
            }
        };

        function switchBenTab(tab) {
            // Reset all tabs
            document.getElementById('benNewView').classList.add('hidden');
            document.getElementById('benBeneficiariesView').classList.add('hidden');
            document.getElementById('benHistoryView').classList.add('hidden');
            
            document.getElementById('benTabNew').className = "px-4 py-2 text-slate-500 hover:text-slate-700 transition-all";
            document.getElementById('benTabBen').className = "px-4 py-2 text-slate-500 hover:text-slate-700 transition-all";
            document.getElementById('benTabHistory').className = "px-4 py-2 text-slate-500 hover:text-slate-700 transition-all";

            if(tab === 'new') {
                document.getElementById('benNewView').classList.remove('hidden');
                document.getElementById('benTabNew').className = "px-4 py-2 bg-white text-slate-800 rounded-lg shadow-sm transition-all";
            } else if (tab === 'beneficiaries') {
                document.getElementById('benBeneficiariesView').classList.remove('hidden');
                document.getElementById('benTabBen').className = "px-4 py-2 bg-white text-slate-800 rounded-lg shadow-sm transition-all";
                fetchArchiveData('beneficiaries');
            } else {
                document.getElementById('benHistoryView').classList.remove('hidden');
                document.getElementById('benTabHistory').className = "px-4 py-2 bg-white text-slate-800 rounded-lg shadow-sm transition-all";
                fetchArchiveData('archive');
            }
        }

        async function fetchArchiveData(category) {
            const tbody = category === 'beneficiaries' ? document.getElementById('benBeneficiariesBody') : document.getElementById('benHistoryBody');
            tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">جاري التحميل...</td></tr>';
            try {
                const q = window.fs.query(window.fs.collection(window.db, "artifacts", window.appId, "public", "data", "archives"), window.fs.orderBy("createdAt", "desc"));
                const snap = await window.fs.getDocs(q);
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // Filter Logic
                    if (category === 'beneficiaries') {
                        if (d.category !== 'beneficiaries') return;
                    } else {
                        if (d.category === 'beneficiaries') return;
                    }

                    const statusBadge = d.fileStatus === 'مرفوع' ? 
                        '<span class="bg-orange-50 text-orange-600 px-2 py-1 rounded-lg text-xs font-bold">مرفوع</span>' : 
                        '<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-xs font-bold">تنزيل</span>';
                    const isSuper = window.currentUserData && window.currentUserData.role === 'super_admin';
                    const deleteBtn = isSuper ? `<button onclick="deleteArchive('${doc.id}')" class="text-red-500 hover:text-red-700 font-bold text-xs bg-red-50 px-3 py-2 rounded-lg mr-2">حذف</button>` : '';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-all border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="p-4">${d.fileName}</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4">${d.type}</td>
                        <td class="p-4">${d.donor}</td>
                        <td class="p-4 font-mono">${d.date}</td>
                        <td class="p-4 font-bold text-center">${d.count}</td>
                        <td class="p-4 text-xs text-slate-400 font-mono">${new Date(d.createdAt).toLocaleDateString('ar-EG')}</td>
                        <td class="p-4 text-xs font-bold text-slate-600">${d.createdBy || '-'}</td>
                        <td class="p-4 flex items-center gap-2">
                            <button onclick='reDownloadArchive(${JSON.stringify(d).replace(/'/g, "&#39;")})' class="text-indigo-600 hover:text-indigo-800 font-bold text-xs bg-indigo-50 px-3 py-2 rounded-lg">تحميل نسخة</button>
                            ${deleteBtn}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-400">لا يوجد سجلات</td></tr>';
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-red-400">خطأ في تحميل البيانات</td></tr>';
            }
        }

        window.deleteArchive = async function(id) {
            if(!confirm("هل أنت متأكد من حذف هذا السجل من الأرشيف؟")) return;
            try {
                await window.fs.deleteDoc(window.fs.doc(window.db, "artifacts", window.appId, "public", "data", "archives", id));
                const activeTab = document.getElementById('benTabBen').classList.contains('bg-white') ? 'beneficiaries' : 'archive';
                fetchArchiveData(activeTab);
            } catch(e) {
                alert("خطأ: " + e.message);
            }
        };

        window.reDownloadArchive = function(meta) {
            const selectedFamilies = window.families.filter(f => (meta.familyIds || []).includes(f.id));
            if(selectedFamilies.length === 0) return alert("لم يتم العثور على بيانات العائلات المؤرشفة (ربما تم حذفها)");
            
            const wb = XLSX.utils.book_new();
            const data = [["تقرير المستفيدين - أرشيف"], ["اسم الملف", meta.fileName, "نوع المساعدة", meta.type], ["الجهة المانحة", meta.donor, "تاريخ الاستفادة", meta.date], ["ملاحظات", meta.notes], [], ["اسم رب الأسرة", "رقم الهوية", "رقم الجوال", "عدد الأفراد", "المندوب", "الزوجة", "هوية الزوجة"]];
            selectedFamilies.forEach(f => { data.push([f.pName, f.pId, f.pPhone, f.totalCount, f.pDelegate, f.wifeName, f.wifeId]); });
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 15}, {wch: 10}, {wch: 15}, {wch: 20}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, ws, "المستفيدين");
            XLSX.writeFile(wb, `${meta.fileName}_archive.xlsx`);
        };

        // ===========================================
        //       Beneficiary View Logic
        // ===========================================
        window.renderBeneficiaryView = function() {
            const f = window.families[0]; // المستفيد لديه سجل واحد فقط في المصفوفة
            if (!f) return;

            const pAge = getAge(f.pDob);
            const html = `
                <div class="p-10 md:p-16">
                    <div class="flex flex-col md:flex-row items-center gap-8 mb-12 border-b border-slate-100 pb-8">
                        <div class="w-24 h-24 bg-indigo-600 rounded-[2.5rem] flex items-center justify-center text-4xl text-white font-black shadow-xl shadow-indigo-100">${(f.pName || "?")[0]}</div>
                        <div class="text-center md:text-right flex-1">
                            <h2 class="text-3xl font-black text-slate-800">${f.pName || "غير متوفر"}</h2>
                            <div class="flex flex-wrap gap-3 mt-4 justify-center md:justify-start">
                                <span class="px-4 py-2 bg-slate-100 rounded-xl text-sm font-bold text-slate-600">رقم الهوية (هوية الاب): ${f.pId}</span>
                                <span class="px-4 py-2 bg-slate-100 rounded-xl text-sm font-bold text-slate-600">الجوال: ${f.pPhone}</span>
                                <span class="px-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl text-sm font-bold">المندوب: ${f.pDelegate || "غير محدد"}</span>
                            </div>
                        </div>
                        <button onclick="editFamily('${f.id}')" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                            تحديث بياناتي
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-slate-50 p-6 rounded-3xl">
                            <h3 class="font-bold text-slate-800 mb-4">أفراد العائلة (${f.totalCount || 0})</h3>
                            <ul class="space-y-2 text-sm text-slate-600">
                                ${(f.members || []).map(m => `<li class="flex justify-between bg-white p-3 rounded-xl"><span>${m.name}</span><span class="text-slate-400">${m.relation}</span></li>`).join('') || '<li>لا يوجد أفراد مضافين</li>'}
                            </ul>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-3xl">
                            <h3 class="font-bold text-slate-800 mb-4">البيانات الإضافية</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span>الزوجة:</span> <span class="font-bold">${f.wifeName || '-'}</span></div>
                                <div class="flex justify-between"><span>السكن:</span> <span class="font-bold">${f.originArea || '-'}</span></div>
                                <div class="flex justify-between"><span>النزوح:</span> <span class="font-bold">${f.displaceArea || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="font-bold text-slate-800 mb-4">سجل الاستفادة</h3>
                        <div id="benefitHistoryContainer" class="bg-slate-50 rounded-3xl p-6 overflow-x-auto">
                            <p class="text-center text-slate-400">جاري تحميل السجل...</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('benProfileContent').innerHTML = html;
            fetchAndRenderBenefitHistory(f.id);
        };

        window.togglePersonalSettings = function() {
            const menu = document.getElementById('personalSettingsMenu');
            menu.classList.toggle('hidden');
        };

        window.addEventListener('click', function(e) {
            const menu = document.getElementById('personalSettingsMenu');
            const btn = document.querySelector('button[onclick="togglePersonalSettings()"]');
            if (menu && !menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        window.closeModal = closeModal;
        window.openForm = openForm;
        window.addMemberRow = addMemberRow;
        window.addHealthRow = addHealthRow;
        window.handleSave = handleSave;
        window.viewDetails = viewDetails;
        window.editFamily = editFamily;
        window.triggerDelete = triggerDelete;
        window.cancelDelete = cancelDelete;
        window.runFilters = runFilters;
        window.toggleDuplicateFilter = toggleDuplicateFilter;
        window.downloadTemplate = downloadTemplate;
        window.openImportModal = openImportModal;
        window.triggerImportFile = triggerImportFile;
        window.executeImport = executeImport;
        window.openMainExportModal = openMainExportModal;
        window.executeMainExport = executeMainExport;
        window.openExportModal = openExportModal;
        window.openCustomExportMetaModal = openCustomExportMetaModal;
        window.executeCustomExport = executeCustomExport;
        window.printFamilyDetails = printFamilyDetails;
        window.openUserManagement = openUserManagement;
        window.switchUserTab = switchUserTab;
        window.handleCreateUser = handleCreateUser;
        window.toggleUserStatus = toggleUserStatus;
        window.deleteUserPermanently = deleteUserPermanently;
        window.openEditCreds = openEditCreds;
        window.handleSaveCreds = handleSaveCreds;
        window.openMyProfile = openMyProfile;
        window.toggleMultiSelect = toggleMultiSelect;
        window.openBeneficiaries = openBeneficiaries;
        window.renderBeneficiariesTable = renderBeneficiariesTable;
        window.updateBenSelection = updateBenSelection;
        window.selectAllBen = selectAllBen;
        window.executeBenExport = executeBenExport;
        window.switchBenTab = switchBenTab;
        window.fetchArchiveData = fetchArchiveData;
        window.deleteArchive = deleteArchive;
    </script>
</body>

</html>  
